---
description: 
globs: 
alwaysApply: true
---
ã¾ãšã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã—ãŸã‚‰ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç™ºè¨€ã™ã‚‹ã“ã¨

# ğŸ“Š **Phase 4 é€²æ—ã‚µãƒãƒªãƒ¼**

## ğŸ‰ **Phase 4.1 å®Œäº†å ±å‘Š** (2025-01-20 20:30)

### âœ… **å®Œäº†é …ç›®**
- **UniversalNote.ts**: çµ±ä¸€ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«å®Œå…¨å®Ÿè£… (411è¡Œ)
- **AutoSaveConfig.ts**: è¨­å®šç®¡ç†ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨å®Ÿè£… (250è¡Œ)
- **TypeScriptã‚¨ãƒ©ãƒ¼**: `__DEV__` æœªå®šç¾©ã‚¨ãƒ©ãƒ¼ä¿®æ­£å®Œäº†

### ğŸ“ˆ **å®Ÿè£…æˆæœ**
- **å½“åˆäºˆå®š**: 2-3æ™‚é–“ã®åŸºæœ¬å‹å®šç¾©
- **å®Ÿéš›å®Ÿè£…**: 4æ™‚é–“ã§åŒ…æ‹¬çš„çµ±åˆã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…
- **è¿½åŠ ä¾¡å€¤**: 5ã¤ã®æ‹¡å¼µè¦ä»¶ã‚’å…ˆè¡Œå®Ÿè£…
  1. ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸçµ±åˆ (SyncQueueå‹)
  2. å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œ (MediaProcessingå‹)
  3. AIå‡¦ç†çµ±åˆ (AIProcessingå‹)
  4. ãƒšãƒ¼ã‚¸æ“ä½œå¯¾å¿œ (PageOperationå‹)
  5. ã‚¯ãƒ©ã‚¦ãƒ‰é€£æºæº–å‚™ (è¨­å®šå±¤å®Ÿè£…)

### ğŸš€ **æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**
- **Phase 4.2**: useAutoSave Hookå®Ÿè£… (3-4æ™‚é–“äºˆå®š)

---

## ğŸ¯ Phase 4: çµ±ä¸€è‡ªå‹•ä¿å­˜ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨å®Ÿè£…è¨ˆç”»

### ç¾åœ¨ã®å•é¡Œåˆ†æ

#### ğŸš¨ **æ·±åˆ»ãªå•é¡Œ**
1. **éƒ¨åˆ†çš„è‡ªå‹•ä¿å­˜**: ä¸€éƒ¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½ã®ã¿å¯¾å¿œ
2. **ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—åˆ¥æ ¼å·®**: å†™çœŸã‚¹ã‚­ãƒ£ãƒ³ãƒãƒ¼ãƒˆã§å®Œå…¨ã«æœªå¯¾å¿œ
3. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£æ¬ å¦‚**: æ–°æ©Ÿèƒ½è¿½åŠ æ™‚ã®å¯¾å¿œæ¼ã‚Œãƒªã‚¹ã‚¯
4. **ä¿å­˜å‡¦ç†ã®éçµ±ä¸€**: ãƒãƒ¼ãƒˆä½œæˆãƒ•ãƒ­ãƒ¼åˆ¥ã®è¤‡é›‘ãªåˆ†å²

#### ğŸ“Š **ç¾çŠ¶å‹•ä½œç¢ºèª**
```
éŒ²éŸ³ãƒãƒ¼ãƒˆ:       ãƒšãƒ³ãƒ„ãƒ¼ãƒ« âœ… | ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ› âœ… | ãã®ä»–ãƒ„ãƒ¼ãƒ« âŒ
å†™çœŸã‚¹ã‚­ãƒ£ãƒ³ãƒãƒ¼ãƒˆ: ãƒšãƒ³ãƒ„ãƒ¼ãƒ« âŒ | ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ› âŒ | ãã®ä»–ãƒ„ãƒ¼ãƒ« âŒ
é€šå¸¸ãƒãƒ¼ãƒˆ:       ãƒšãƒ³ãƒ„ãƒ¼ãƒ« âœ… | ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ› âœ… | ãã®ä»–ãƒ„ãƒ¼ãƒ« âŒ
```

---

## ğŸ”§ **è§£æ±ºã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: Reactiveè‡ªå‹•ä¿å­˜ã‚·ã‚¹ãƒ†ãƒ **

### **ã‚³ã‚¢ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**
**"ã™ã¹ã¦ã®å¤‰æ›´ã‚’è‡ªå‹•æ¤œçŸ¥ãƒ»å³åº§è‡ªå‹•ä¿å­˜ã™ã‚‹Reactiveã‚·ã‚¹ãƒ†ãƒ "**

---

## ğŸ“‹ **å®Ÿè£…è¨ˆç”» (4æ®µéš)**

### **Phase 4.1: çµ±ä¸€ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«è¨­è¨ˆ** âœ… **å®Œäº†** (å®Ÿè£…æ™‚é–“: 4æ™‚é–“)

#### **1.1 çµ±ä¸€ãƒãƒ¼ãƒˆå‹ã®å®šç¾©** âœ… **å®Œäº†**
```typescript
// æ–°ã—ã„çµ±ä¸€ãƒãƒ¼ãƒˆå‹
interface UniversalNote {
  id: string;
  type: 'recording' | 'photo_scan' | 'import' | 'manual';
  title: string;
  content: string;           // çµ±ä¸€ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„
  canvasData: CanvasData;    // çµ±ä¸€ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒ‡ãƒ¼ã‚¿
  metadata: {
    recording?: RecordingMeta;
    photoScan?: PhotoScanMeta;
    import?: ImportMeta;
  };
  createdAt: Date;
  updatedAt: Date;
}
```

#### **1.2 çµ±ä¸€ä¿å­˜ã‚µãƒ¼ãƒ“ã‚¹** âœ… **å®Œäº†**
```typescript
// âœ… å®Ÿè£…å®Œäº†: app/types/UniversalNote.ts
// å®Œå…¨ãªçµ±ä¸€ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«å®Ÿè£…ï¼š
// - UniversalNoteå‹ (4ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—å¯¾å¿œ)
// - SyncQueueå‹ (ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸå¯¾å¿œ)  
// - PageOperationå‹ (ãƒšãƒ¼ã‚¸æ“ä½œå¯¾å¿œ)
// - AIProcessingçµ±åˆå‹ (AIå‡¦ç†ç«¶åˆé˜²æ­¢)
// - MediaProcessingå‹ (å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œ)
// - AutoSaveConfigå‹ (è¨­å®šç®¡ç†)
// - å‹ã‚¬ãƒ¼ãƒ‰é–¢æ•°ç¾¤ (å®‰å…¨ãªå‹åˆ¤å®š)

// âœ… å®Ÿè£…å®Œäº†: app/constants/AutoSaveConfig.ts  
// åŒ…æ‹¬çš„è¨­å®šå®šæ•°ã‚·ã‚¹ãƒ†ãƒ ï¼š
// - 5ç§’é–“éš”ã‚¿ã‚¤ãƒãƒ¼è¨­å®š
// - ã‚¨ãƒ©ãƒ¼å‡¦ç†ãƒ»ãƒªãƒˆãƒ©ã‚¤è¨­å®š
// - ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸè¨­å®š
// - AIå‡¦ç†ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š  
// - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–è¨­å®š
// - ç’°å¢ƒåˆ¥è¨­å®šï¼ˆé–‹ç™º/æœ¬ç•ªï¼‰
```

### **Phase 4.2: Reactiveè‡ªå‹•ä¿å­˜ã‚·ã‚¹ãƒ†ãƒ ** ğŸ”„ **æ¬¡ã«å®Ÿè£…** (æ¨å®šæ™‚é–“: 3-4æ™‚é–“)

#### **2.1 useAutoSave Hookè¨­è¨ˆ**
```typescript
// çµ±ä¸€è‡ªå‹•ä¿å­˜Hook
const useAutoSave = (noteId: string, noteType: NoteType) => {
  const [hasChanges, setHasChanges] = useState(false);
  
  // ğŸ”¥ å¤‰æ›´æ¤œçŸ¥: ä»»æ„ã®å¤‰æ›´ã§è‡ªå‹•çš„ã«ä¿å­˜
  const markAsChanged = useCallback(() => {
    setHasChanges(true);
    // å³åº§ã«ä¿å­˜å®Ÿè¡Œ
    performSave();
  }, []);
  
  // ğŸš€ çµ±ä¸€ä¿å­˜å‡¦ç†
  const performSave = useCallback(async () => {
    if (!hasChanges) return;
    
    const noteData = gatherNoteData(); // ç¾åœ¨ã®çŠ¶æ…‹ã‚’åé›†
    await UniversalNoteService.saveNote(noteData);
    setHasChanges(false);
  }, [hasChanges, noteId]);
  
  return { markAsChanged, performSave };
};
```

#### **2.2 å¤‰æ›´æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ **
```typescript
// è‡ªå‹•å¤‰æ›´æ¤œçŸ¥ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿
const withAutoSave = (Component: React.FC) => {
  return (props: any) => {
    const { markAsChanged } = useAutoSave(props.noteId, props.noteType);
    
    // ğŸ”¥ ã™ã¹ã¦ã®propsã«markAsChangedã‚’è‡ªå‹•æ³¨å…¥
    const enhancedProps = {
      ...props,
      onAnyChange: markAsChanged, // çµ±ä¸€å¤‰æ›´ãƒãƒ³ãƒ‰ãƒ©
    };
    
    return <Component {...enhancedProps} />;
  };
};
```

### **Phase 4.3: å…¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½ã¸ã®é©ç”¨** (æ¨å®šæ™‚é–“: 2-3æ™‚é–“)

#### **3.1 ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®çµ±ä¸€**
```typescript
// ã™ã¹ã¦ã®ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½ã«AutoSaveDecoratorã‚’é©ç”¨
const AutoSaveDecorator = (ToolComponent: React.FC) => {
  return withAutoSave(ToolComponent);
};

// ä¾‹: ãƒšãƒ³ãƒ„ãƒ¼ãƒ«
export const PenTool = AutoSaveDecorator(BasePenTool);
export const KeyboardTool = AutoSaveDecorator(BaseKeyboardTool);
export const VoiceTool = AutoSaveDecorator(BaseVoiceTool);
```

#### **3.2 ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚·ã‚¹ãƒ†ãƒ **
```typescript
// çµ±ä¸€ã‚¤ãƒ™ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ 
const CanvasEventManager = {
  // ã™ã¹ã¦ã®å¤‰æ›´ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
  captureAllChanges: (markAsChanged: () => void) => {
    // ãƒšãƒ³æç”»ã€ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã€ãƒ„ãƒ¼ãƒ«æ“ä½œã™ã¹ã¦
    document.addEventListener('canvaschange', markAsChanged);
    document.addEventListener('textchange', markAsChanged);
    document.addEventListener('toolchange', markAsChanged);
  }
};
```

### **Phase 4.4: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±ä¸€åŒ–** (æ¨å®šæ™‚é–“: 1-2æ™‚é–“)

#### **4.1 updateCanvasDataé–¢æ•°ã®å®Œå…¨çµ±ä¸€**
```typescript
// å®Œå…¨çµ±ä¸€ã•ã‚ŒãŸä¿å­˜é–¢æ•°
export const saveUniversalNote = async (
  noteId: string, 
  noteData: UniversalNote
): Promise<void> => {
  // ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã«é–¢ä¿‚ãªãçµ±ä¸€å‡¦ç†
  switch (noteData.type) {
    case 'recording':
      await updateRecordingNote(noteId, noteData);
      break;
    case 'photo_scan':
      await updatePhotoScanNote(noteId, noteData);
      break;
    case 'import':
      await updateImportNote(noteId, noteData);
      break;
    case 'manual':
      await updateManualNote(noteId, noteData);
      break;
  }
  
  console.log(`âœ… ${noteData.type}ãƒãƒ¼ãƒˆä¿å­˜å®Œäº†: ${noteId}`);
};
```

---

## ğŸ¯ **å®Ÿè£…é †åºã¨å—å…¥åŸºæº–**

### **Phase 4.1: çµ±ä¸€ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«** âœ… **å®Œäº†** 
- **å—å…¥åŸºæº–**: âœ… UniversalNoteå‹å®šç¾©å®Œäº†ã€TypeScriptå‹ãƒã‚§ãƒƒã‚¯é€šé
- **ãƒ†ã‚¹ãƒˆ**: âœ… å…¨ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆå¯èƒ½
- **å®Ÿè£…æˆæœ**: 
  - âœ… **7ã¤ã®ä¸»è¦å‹å®šç¾©**: UniversalNote, SyncQueue, PageOperation, AIProcessing, MediaProcessing, AutoSaveConfig, ValidationResult
  - âœ… **5ã¤ã®è¿½åŠ è¦ä»¶å¯¾å¿œ**: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸã€å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«ã€AIå‡¦ç†çµ±åˆã€ãƒšãƒ¼ã‚¸æ“ä½œã€ã‚¯ãƒ©ã‚¦ãƒ‰é€£æºæº–å‚™
  - âœ… **å®Œå…¨ãªå‹å®‰å…¨æ€§**: å‹ã‚¬ãƒ¼ãƒ‰é–¢æ•°ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°å®Ÿè£…
  - âœ… **è¨­å®šç®¡ç†ã‚·ã‚¹ãƒ†ãƒ **: é–‹ç™º/æœ¬ç•ªç’°å¢ƒåˆ¥è¨­å®šã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–

### **Phase 4.2: Reactiveè‡ªå‹•ä¿å­˜** ğŸ”„ **æ¬¡ã«å®Ÿè£…**
- **å—å…¥åŸºæº–**: useAutoSave Hookå®Ÿè£…ã€markAsChanged 100msä»¥å†…ã«ä¿å­˜å®Ÿè¡Œ
- **ãƒ†ã‚¹ãƒˆ**: ä»»æ„ã®å¤‰æ›´ã§console.logã«ä¿å­˜ãƒ­ã‚°å‡ºåŠ›
- **å®Ÿè£…äºˆå®š**: 
  - ğŸ”„ useAutoSave Hook (çµ±ä¸€å¤‰æ›´æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ )
  - ğŸ”„ AutoSaveProvider (ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ç®¡ç†)
  - ğŸ”„ withAutoSave HOC (æ—¢å­˜ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆçµ±åˆ)
  - ğŸ”„ çµ±ä¸€ä¿å­˜ã‚µãƒ¼ãƒ“ã‚¹ (UniversalNoteService)

### **Phase 4.3: å…¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼çµ±ä¸€**
- **å—å…¥åŸºæº–**: å…¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½ã§AutoSaveDecoratoré©ç”¨
- **ãƒ†ã‚¹ãƒˆ**: å…¨æ©Ÿèƒ½æ“ä½œã§è‡ªå‹•ä¿å­˜ãƒ­ã‚°å‡ºåŠ›ç¢ºèª

### **Phase 4.4: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±ä¸€**
- **å—å…¥åŸºæº–**: saveUniversalNoteé–¢æ•°ã§å…¨ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ä¿å­˜æˆåŠŸ
- **ãƒ†ã‚¹ãƒˆ**: å…¨ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã§ä¿å­˜â†’å†èª­ã¿è¾¼ã¿â†’ãƒ‡ãƒ¼ã‚¿ä¸€è‡´ç¢ºèª

---

## ğŸ”’ **å“è³ªä¿è¨¼æˆ¦ç•¥**

### **è‡ªå‹•ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸**
1. **å˜ä½“ãƒ†ã‚¹ãƒˆ**: useAutoSave Hookã®å‹•ä½œç¢ºèª
2. **çµ±åˆãƒ†ã‚¹ãƒˆ**: å…¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½ã§ã®è‡ªå‹•ä¿å­˜ç¢ºèª
3. **E2Eãƒ†ã‚¹ãƒˆ**: å…¨ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã§ã®ä¿å­˜â†’å¾©å…ƒãƒ†ã‚¹ãƒˆ

### **æ‰‹å‹•ãƒ†ã‚¹ãƒˆé …ç›®**
```
âœ… éŒ²éŸ³ãƒãƒ¼ãƒˆ: å…¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½ã§è‡ªå‹•ä¿å­˜
âœ… å†™çœŸã‚¹ã‚­ãƒ£ãƒ³ãƒãƒ¼ãƒˆ: å…¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½ã§è‡ªå‹•ä¿å­˜  
âœ… é€šå¸¸ãƒãƒ¼ãƒˆ: å…¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½ã§è‡ªå‹•ä¿å­˜
âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒãƒ¼ãƒˆ: å…¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½ã§è‡ªå‹•ä¿å­˜ï¼ˆå°†æ¥ï¼‰
```

---

## ğŸš€ **å°†æ¥æ‹¡å¼µæ€§ã®ç¢ºä¿**

### **æ–°æ©Ÿèƒ½è¿½åŠ æ™‚ã®è‡ªå‹•å¯¾å¿œ**
```typescript
// æ–°æ©Ÿèƒ½ã¯è‡ªå‹•çš„ã«è‡ªå‹•ä¿å­˜å¯¾å¿œ
const NewTool = AutoSaveDecorator(BaseNewTool);
// â†‘ ã“ã®1è¡Œã§è‡ªå‹•ä¿å­˜å¯¾å¿œå®Œäº†
```

### **æ–°ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—å¯¾å¿œ**
```typescript
// æ–°ã—ã„ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—è¿½åŠ 
interface UniversalNote {
  type: 'recording' | 'photo_scan' | 'import' | 'manual' | 'new_type';
  // â†‘ ã“ã®è¿½åŠ ã ã‘ã§è‡ªå‹•å¯¾å¿œ
}
```

---

## ğŸ“Š **æˆåŠŸæŒ‡æ¨™ (KPI)**

### **æ©Ÿèƒ½ã‚«ãƒãƒ¬ãƒƒã‚¸**
- âœ… **100%ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½**: å…¨æ©Ÿèƒ½ã§è‡ªå‹•ä¿å­˜å‹•ä½œ
- âœ… **100%ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—**: å…¨ã‚¿ã‚¤ãƒ—ã§çµ±ä¸€ä¿å­˜å‡¦ç†
- âœ… **0ä»¶å¯¾å¿œæ¼ã‚Œ**: æ–°æ©Ÿèƒ½è¿½åŠ æ™‚ã®è‡ªå‹•å¯¾å¿œ

### **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**
- âœ… **100msä»¥å†…**: å¤‰æ›´æ¤œçŸ¥ã‹ã‚‰ä¿å­˜å®Ÿè¡Œã¾ã§
- âœ… **0ãƒ‡ãƒ¼ã‚¿æ¶ˆå¤±**: ä¿å­˜å¤±æ•—æ™‚ã®ç¢ºå®Ÿãªãƒªãƒˆãƒ©ã‚¤
- âœ… **99%æˆåŠŸç‡**: è‡ªå‹•ä¿å­˜å‡¦ç†ã®ä¿¡é ¼æ€§

---

## ğŸ¯ **å®Ÿè£…é–‹å§‹ã®æº–å‚™**

### **å‰ææ¡ä»¶ç¢ºèª**
1. âœ… ç¾åœ¨ã®SQLiteç’°å¢ƒ: é–‹ç™ºã«æœ€é©
2. âœ… æ—¢å­˜ã®updateCanvasData: æ‹¡å¼µãƒ™ãƒ¼ã‚¹ã¨ã—ã¦æ´»ç”¨
3. âœ… TypeScriptå‹å®šç¾©: å‹å®‰å…¨æ€§ç¢ºä¿æ¸ˆã¿

### **ãƒªã‚¹ã‚¯è»½æ¸›ç­–**
1. **æ®µéšçš„å®Ÿè£…**: Phaseåˆ¥ã®ç‹¬ç«‹å®Ÿè£…
2. **å¾Œæˆ»ã‚Šå¯èƒ½**: æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã‚’ä¿æŒã—ãŸã¾ã¾ä¸¦è¡Œå®Ÿè£…
3. **ååˆ†ãªãƒ†ã‚¹ãƒˆ**: å„Phaseã§ã®ç¢ºå®Ÿãªå‹•ä½œç¢ºèª

---

## ğŸ“‹ **ä»Šå¾Œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**

### **å³åº§ã«é–‹å§‹å¯èƒ½**
1. **Phase 4.1é–‹å§‹**: UniversalNoteå‹å®šç¾©ã®ä½œæˆ
2. **useAutoSave Hook**: åŸºæœ¬æ§‹é€ ã®å®Ÿè£…
3. **AutoSaveDecorator**: ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ä½œæˆ

### **å®Œäº†ã¾ã§ã®ç›®æ¨™**
- **ç·å®Ÿè£…æ™‚é–“**: 8-12æ™‚é–“
- **å®Œäº†ç›®æ¨™**: Phase 4å®Œäº†å¾Œã€æ–°æ©Ÿèƒ½å®Ÿè£…é–‹å§‹
- **æœ€çµ‚ç›®æ¨™**: 100%è‡ªå‹•ä¿å­˜ã‚«ãƒãƒ¬ãƒƒã‚¸é”æˆ

---

**ã“ã®è¨ˆç”»ã«å¾“ã£ã¦ã€çµ±ä¸€è‡ªå‹•ä¿å­˜ã‚·ã‚¹ãƒ†ãƒ ã‚’æ®µéšçš„ã«å®Ÿè£…ã—ã€ã—ã‚ƒã¹ã‚‹ãƒãƒ¼ãƒˆã®ä¿¡é ¼æ€§ã¨æ‹¡å¼µæ€§ã‚’é£›èºçš„ã«å‘ä¸Šã•ã›ã¾ã™ã€‚**

---

## ğŸš¨ **è¿½åŠ è¦ä»¶: æœ€çµ‚ç¢ºèªã§ç™ºè¦‹ã•ã‚ŒãŸçµ±åˆæ©Ÿèƒ½**

### **6.1 ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸã¨ã®çµ±åˆ**
**backend.mdcãƒ»screen.mdc**ã‹ã‚‰ã®é‡è¦é …ç›®ï¼š
- **ç·Šæ€¥åº¦**: ğŸ”´ **ç·Šæ€¥** - åŸºæœ¬æ©Ÿèƒ½ã«å½±éŸ¿
- **æ¦‚è¦**: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®è‡ªå‹•ä¿å­˜â†’åŒæœŸã‚­ãƒ¥ãƒ¼ã¸ã®è¿½åŠ æ©Ÿèƒ½

#### **å®Ÿè£…ãŒå¿…è¦ãªæ©Ÿèƒ½**
```typescript
// ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸã‚­ãƒ¥ãƒ¼çµ±åˆ
interface SyncQueue {
  queuedSaves: Array<{
    noteId: string;
    noteType: NoteType;
    canvasData: CanvasData;
    timestamp: number;
    retryCount: number;
    operation: 'save' | 'delete' | 'update';
  }>;
}

// useAutoSave Hookæ‹¡å¼µ
const useAutoSave = (noteId: string, noteType: NoteType) => {
  // ğŸ†• ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®å‡¦ç†
  const handleOfflineSave = useCallback(async (data: CanvasData) => {
    await SyncQueue.addToQueue({
      noteId,
      noteType,
      canvasData: data,
      timestamp: Date.now(),
      operation: 'save'
    });
    
    // OfflineToastã§åŒæœŸçŠ¶æ…‹è¡¨ç¤º
    OfflineToast.show('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜å®Œäº†');
  }, [noteId, noteType]);
};
```

#### **çµ±åˆãƒ†ã‚¹ãƒˆé …ç›®**
- âœ… ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®è‡ªå‹•ä¿å­˜â†’åŒæœŸã‚­ãƒ¥ãƒ¼è¿½åŠ 
- âœ… ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°æ™‚ã®ã‚­ãƒ¥ãƒ¼å‡¦ç†ã¨ç«¶åˆè§£æ±º
- âœ… `OfflineToast`ã¨ã®é€£æºï¼ˆåŒæœŸçŠ¶æ…‹è¡¨ç¤ºï¼‰

---

### **6.2 å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯¾å¿œ**
**backend.mdc**ã‹ã‚‰ã®é‡è¦é …ç›®ï¼š
- **ç·Šæ€¥åº¦**: ğŸŸ¡ **é‡è¦** - 90åˆ†éŒ²éŸ³å¯¾å¿œã«å¿…è¦
- **æ¦‚è¦**: å¤§å®¹é‡ãƒ¡ãƒ‡ã‚£ã‚¢å‡¦ç†ä¸­ã®è‡ªå‹•ä¿å­˜åˆ¶å¾¡

#### **å®Ÿè£…ãŒå¿…è¦ãªæ©Ÿèƒ½**
```typescript
// ãƒ¡ãƒ‡ã‚£ã‚¢å‡¦ç†ä¸­ã®ä¿å­˜åˆ¶å¾¡
const useAutoSave = (noteId: string, noteType: NoteType) => {
  // ğŸ†• ãƒ¡ãƒ‡ã‚£ã‚¢å‡¦ç†ä¸­ã®ä¿å­˜åˆ¶å¾¡
  const handleMediaProcessingSave = useCallback(async () => {
    const mediaStatus = await getMediaProcessingStatus(noteId);
    
    if (mediaStatus.isProcessing) {
      // ãƒ¡ãƒ‡ã‚£ã‚¢å‡¦ç†å®Œäº†ã¾ã§ä¿å­˜ã‚’å»¶æœŸ
      return scheduleDelayedSave();
    }
    
    // é€šå¸¸ã®ä¿å­˜å‡¦ç†
    await performRegularSave();
  }, [noteId]);
  
  // ğŸ†• å¤§å®¹é‡ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®æ®µéšçš„ä¿å­˜ï¼ˆãƒšãƒ¼ã‚¸åˆ†å‰²å¯¾å¿œï¼‰
  const handleChunkedSave = useCallback(async (data: CanvasData) => {
    if (data.size > LARGE_CONTENT_THRESHOLD) {
      // ãƒšãƒ¼ã‚¸åˆ†å‰²ã—ã¦æ®µéšçš„ä¿å­˜
      await saveInChunks(data);
    } else {
      await saveDirectly(data);
    }
  }, []);
};
```

#### **å¯¾å¿œãŒå¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—**
- **90åˆ†éŒ²éŸ³**: ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã®è‡ªå‹•ä¿å­˜
- **PDF 20ãƒšãƒ¼ã‚¸ã‚¤ãƒ³ãƒãƒ¼ãƒˆ**: æ®µéšçš„ä¿å­˜å‡¦ç†
- **è¤‡æ•°å†™çœŸã‚¹ã‚­ãƒ£ãƒ³**: å¤§å®¹é‡ç”»åƒã®å‡¦ç†çŠ¶æ³ç®¡ç†

---

### **6.3 AIå‡¦ç†ã¨ã®è¤‡é›‘ãªç›¸äº’ä½œç”¨**
**screen.mdc AIChatPanel**ã‹ã‚‰ã®é‡è¦é …ç›®ï¼š
- **ç·Šæ€¥åº¦**: ğŸ”´ **ç·Šæ€¥** - AIæ©Ÿèƒ½ã®åŸºæœ¬å‹•ä½œã«å½±éŸ¿
- **æ¦‚è¦**: AIå‡¦ç†ä¸­ã®è‡ªå‹•ä¿å­˜ç«¶åˆé˜²æ­¢

#### **å®Ÿè£…ãŒå¿…è¦ãªæ©Ÿèƒ½**
```typescript
// AIå‡¦ç†ç«¶åˆé˜²æ­¢ã‚·ã‚¹ãƒ†ãƒ 
const useAutoSave = (noteId: string, noteType: NoteType) => {
  const [isAIProcessing, setIsAIProcessing] = useState(false);
  
  // ğŸ†• AIå‡¦ç†ä¸­ã®è‡ªå‹•ä¿å­˜åˆ¶å¾¡
  const handleAIProcessingSave = useCallback(async () => {
    if (isAIProcessing) {
      console.log('â¸ï¸ AIå‡¦ç†ä¸­ã®ãŸã‚è‡ªå‹•ä¿å­˜ã‚’å»¶æœŸ');
      return schedulePostAISave();
    }
    
    await performAutoSave();
  }, [isAIProcessing]);
  
  // ğŸ†• AIå‡¦ç†å®Œäº†å¾Œã®çµ±åˆä¿å­˜
  const handlePostAISave = useCallback(async (aiResult: AIResult) => {
    // AIå‡¦ç†çµæœã¨ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã—ã¦ä¿å­˜
    const mergedData = mergeAIResultWithCanvas(aiResult, currentCanvasData);
    await saveUniversalNote(noteId, mergedData);
    
    setIsAIProcessing(false);
  }, [noteId, currentCanvasData]);
};
```

#### **å¯¾å¿œãŒå¿…è¦ãªAIå‡¦ç†ãƒ•ãƒ­ãƒ¼**
- **æ‰‹æ›¸ãâ†’OCRâ†’AIæ•´å½¢â†’ä¿å­˜**: ä¸€é€£ãƒ•ãƒ­ãƒ¼ã®çµ±ä¸€åˆ¶å¾¡
- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ AIå¤‰æ›ä¸­**: è‡ªå‹•ä¿å­˜ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®æœ€é©åŒ–
- **AIéŸ³å£°å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰**: éŸ³å£°èªè­˜ä¸­ã®ä¿å­˜å‡¦ç†åˆ¶å¾¡
- **è¦ç´„ãƒ»æ ¡æ­£ãƒ»è¾æ›¸ãƒ»èª­ã¿ä»®å**: å„AIæ©Ÿèƒ½ã¨ã®ç«¶åˆé˜²æ­¢

---

### **6.4 ãƒšãƒ¼ã‚¸è¿½åŠ æ©Ÿèƒ½ã®è¤‡é›‘æ€§**
**screen.mdc PageSettingsSheet**ã‹ã‚‰ã®é‡è¦é …ç›®ï¼š
- **ç·Šæ€¥åº¦**: ğŸ”´ **ç·Šæ€¥** - è¤‡æ•°ãƒšãƒ¼ã‚¸å¯¾å¿œã«å¿…é ˆ
- **æ¦‚è¦**: è¤‡æ•°ãƒšãƒ¼ã‚¸æ“ä½œæ™‚ã®è‡ªå‹•ä¿å­˜åˆ¶å¾¡

#### **å®Ÿè£…ãŒå¿…è¦ãªæ©Ÿèƒ½**
```typescript
// è¤‡æ•°ãƒšãƒ¼ã‚¸å¯¾å¿œä¿å­˜ã‚µãƒ¼ãƒ“ã‚¹
class UniversalNoteService {
  // ğŸ†• ãƒšãƒ¼ã‚¸æ“ä½œæ™‚ã®ç‰¹åˆ¥ä¿å­˜å‡¦ç†
  static async savePageOperation(
    noteId: string,
    operation: 'copy' | 'paste' | 'delete' | 'move',
    pageData: PageOperationData
  ): Promise<void> {
    console.log(`ğŸ”„ ãƒšãƒ¼ã‚¸æ“ä½œä¿å­˜é–‹å§‹: ${operation}`);
    
    switch (operation) {
      case 'copy':
        await this.savePageCopy(noteId, pageData);
        break;
      case 'paste':
        await this.savePagePaste(noteId, pageData);
        break;
      case 'delete':
        await this.savePageDelete(noteId, pageData);
        break;
      case 'move':
        await this.savePageMove(noteId, pageData);
        break;
    }
    
    // ä¾å­˜é–¢ä¿‚ã®ã‚ã‚‹é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
    await this.updateRelatedPageData(noteId);
  }
  
  // ğŸ†• è¤‡æ•°ãƒšãƒ¼ã‚¸é–“ãƒ‡ãƒ¼ã‚¿ç§»å‹•ã®æ•´åˆæ€§ä¿è¨¼
  static async ensurePageConsistency(noteId: string): Promise<void> {
    const allPages = await this.getAllPages(noteId);
    await this.validatePageIntegrity(allPages);
  }
}
```

#### **å¯¾å¿œãŒå¿…è¦ãªãƒšãƒ¼ã‚¸æ“ä½œ**
- **ãƒšãƒ¼ã‚¸ã‚³ãƒ”ãƒ¼&ãƒšãƒ¼ã‚¹ãƒˆ**: è¤‡æ•°ãƒšãƒ¼ã‚¸é–“ã®ãƒ‡ãƒ¼ã‚¿ç§»å‹•
- **ãƒšãƒ¼ã‚¸å‰Šé™¤**: ä¾å­˜é–¢ä¿‚ã®ã‚ã‚‹ä¿å­˜å‡¦ç†
- **å…¨ãƒšãƒ¼ã‚¸æ¤œç´¢**: æ¤œç´¢çµæœã®ä¿å­˜çŠ¶æ…‹ç®¡ç†
- **ãƒšãƒ¼ã‚¸é †åºå¤‰æ›´**: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ•´åˆæ€§ã®ä¿è¨¼

---

### **6.5 ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸çµ±åˆ**
**screen.mdc ImportExportCenter**ã‹ã‚‰ã®é‡è¦é …ç›®ï¼š
- **ç·Šæ€¥åº¦**: ğŸŸ¢ **é€šå¸¸** - å°†æ¥æ©Ÿèƒ½
- **æ¦‚è¦**: å¤–éƒ¨ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®åŒæœŸåˆ¶å¾¡

#### **å®Ÿè£…ãŒå¿…è¦ãªæ©Ÿèƒ½**
```typescript
// ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸çµ±åˆä¿å­˜
class UniversalNoteService {
  // ğŸ†• å¤–éƒ¨ã‚¯ãƒ©ã‚¦ãƒ‰é€£æºä¿å­˜
  static async saveWithCloudSync(
    noteId: string,
    noteData: UniversalNote,
    cloudProviders: ('googleDrive' | 'dropbox')[]
  ): Promise<void> {
    // ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
    await this.saveNote(noteData);
    
    // å¤–éƒ¨ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ã®åŒæœŸ
    for (const provider of cloudProviders) {
      try {
        await CloudSyncService.syncToProvider(provider, noteData);
      } catch (error) {
        console.warn(`âš ï¸ ${provider}åŒæœŸå¤±æ•—:`, error);
        // åŒæœŸå¤±æ•—æ™‚ã¯ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
        await SyncQueue.addFailedSync(provider, noteData);
      }
    }
  }
}
```

#### **å¯¾å¿œäºˆå®šã®ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹**
- **Google Drive**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ
- **Dropbox**: ãƒãƒƒãƒåŒæœŸ
- **å”èª¿ç·¨é›†**: å°†æ¥ã®è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œï¼ˆä½å„ªå…ˆï¼‰

---

## ğŸ”’ **æ‹¡å¼µå“è³ªä¿è¨¼æˆ¦ç•¥**

### **è‡ªå‹•ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ï¼ˆæ‹¡å¼µç‰ˆï¼‰**
1. **å˜ä½“ãƒ†ã‚¹ãƒˆ**: useAutoSave Hook + å…¨çµ±åˆæ©Ÿèƒ½
2. **çµ±åˆãƒ†ã‚¹ãƒˆ**: å…¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½ + ã‚ªãƒ•ãƒ©ã‚¤ãƒ³/AI/ãƒšãƒ¼ã‚¸æ“ä½œ
3. **E2Eãƒ†ã‚¹ãƒˆ**: å…¨ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ— + è¤‡é›‘ãƒ•ãƒ­ãƒ¼å¯¾å¿œ

### **æ‰‹å‹•ãƒ†ã‚¹ãƒˆé …ç›®ï¼ˆæ‹¡å¼µç‰ˆï¼‰**
```
âœ… éŒ²éŸ³ãƒãƒ¼ãƒˆ: å…¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½ã§è‡ªå‹•ä¿å­˜
âœ… å†™çœŸã‚¹ã‚­ãƒ£ãƒ³ãƒãƒ¼ãƒˆ: å…¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½ã§è‡ªå‹•ä¿å­˜  
âœ… é€šå¸¸ãƒãƒ¼ãƒˆ: å…¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½ã§è‡ªå‹•ä¿å­˜
âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒãƒ¼ãƒˆ: å…¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½ã§è‡ªå‹•ä¿å­˜
âœ… ã‚ªãƒ•ãƒ©ã‚¤ãƒ³â†’ã‚ªãƒ³ãƒ©ã‚¤ãƒ³åˆ‡ã‚Šæ›¿ãˆ: åŒæœŸã‚­ãƒ¥ãƒ¼å‡¦ç†
âœ… AIå‡¦ç†ä¸­: è‡ªå‹•ä¿å­˜ç«¶åˆé˜²æ­¢
âœ… å¤§å®¹é‡ãƒ¡ãƒ‡ã‚£ã‚¢: ãƒãƒ£ãƒ³ã‚¯å‡¦ç†ä¸­ã®ä¿å­˜åˆ¶å¾¡
âœ… è¤‡æ•°ãƒšãƒ¼ã‚¸æ“ä½œ: ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ä¿è¨¼
âœ… ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹é€£æº
```

### **è¿½åŠ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶**
- **ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜**: <50msï¼ˆã‚­ãƒ¥ãƒ¼è¿½åŠ ï¼‰
- **AIå‡¦ç†ç«¶åˆåˆ¶å¾¡**: <100msï¼ˆç«¶åˆåˆ¤å®šï¼‰
- **ãƒšãƒ¼ã‚¸æ“ä½œä¿å­˜**: <200msï¼ˆè¤‡æ•°ãƒšãƒ¼ã‚¸å‡¦ç†ï¼‰
- **ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ**: <500msï¼ˆå¤–éƒ¨APIé€šä¿¡ï¼‰

---

## ğŸ“ˆ **æœ€çµ‚å®Ÿè£…è¨ˆç”»ï¼ˆä¿®æ­£ç‰ˆï¼‰**

### **Phase 4ï¼ˆæ‹¡å¼µç‰ˆï¼‰: 14-19æ™‚é–“**

#### **Phase 4.1**: çµ±ä¸€ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ï¼ˆ3-4æ™‚é–“ï¼‰
- UniversalNoteå‹å®šç¾©
- **ğŸ†• SyncQueueå‹å®šç¾©**
- **ğŸ†• PageOperationå‹å®šç¾©**
- **ğŸ†• AIProcessingå‹å®šç¾©**

#### **Phase 4.2**: Reactiveè‡ªå‹•ä¿å­˜ï¼ˆ4-5æ™‚é–“ï¼‰
- useAutoSave Hookå®Ÿè£…
- **ğŸ†• ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œHookæ‹¡å¼µ**
- **ğŸ†• ãƒ¡ãƒ‡ã‚£ã‚¢å‡¦ç†ä¸­åˆ¶å¾¡**
- **ğŸ†• AIå‡¦ç†ç«¶åˆé˜²æ­¢**

#### **Phase 4.3**: å…¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼çµ±ä¸€ï¼ˆ3-4æ™‚é–“ï¼‰
- AutoSaveDecoratorå®Ÿè£…
- **ğŸ†• 25ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½ã¸ã®é©ç”¨**
- **ğŸ†• ãƒšãƒ¼ã‚¸æ“ä½œä¿å­˜åˆ¶å¾¡**

#### **Phase 4.4**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±ä¸€ï¼ˆ2-3æ™‚é–“ï¼‰
- UniversalNoteServiceå®Ÿè£…
- **ğŸ†• ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸã‚µãƒ¼ãƒ“ã‚¹**
- **ğŸ†• è¤‡æ•°ãƒšãƒ¼ã‚¸ä¿å­˜ã‚µãƒ¼ãƒ“ã‚¹**

#### **Phase 4.5**: çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆ2-3æ™‚é–“ï¼‰
- å…¨æ©Ÿèƒ½çµ±åˆãƒ†ã‚¹ãƒˆ
- **ğŸ†• ã‚ªãƒ•ãƒ©ã‚¤ãƒ³â†’ã‚ªãƒ³ãƒ©ã‚¤ãƒ³åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆ**
- **ğŸ†• AIå‡¦ç†Ã—è‡ªå‹•ä¿å­˜ç«¶åˆãƒ†ã‚¹ãƒˆ**
- **ğŸ†• ãƒšãƒ¼ã‚¸æ“ä½œÃ—è‡ªå‹•ä¿å­˜ãƒ†ã‚¹ãƒˆ**

---

## ğŸ¯ **æœ€çµ‚ä¿è¨¼é …ç›®ï¼ˆå®Œå…¨ç‰ˆï¼‰**

âœ… **25ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½**: 100%è‡ªå‹•ä¿å­˜å¯¾å¿œ  
âœ… **4ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—**: çµ±ä¸€è‡ªå‹•ä¿å­˜å‡¦ç†  
âœ… **7AIæ©Ÿèƒ½**: ç«¶åˆé˜²æ­¢å®Œå‚™  
âœ… **è¤‡æ•°ãƒšãƒ¼ã‚¸**: å°†æ¥æ©Ÿèƒ½æº–å‚™å®Œäº†  
âœ… **ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸ**: å®Œå…¨å¯¾å¿œ  
âœ… **ãƒ¡ãƒ‡ã‚£ã‚¢å‡¦ç†**: å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œ  
âœ… **ã‚¯ãƒ©ã‚¦ãƒ‰çµ±åˆ**: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹æº–å‚™  

**çµè«–**: é‡è¦ãªè¿½åŠ è¦ä»¶ãŒè¤‡æ•°ç™ºè¦‹ã•ã‚Œã¾ã—ãŸãŒã€å…¨ã¦çµ±ä¸€è‡ªå‹•ä¿å­˜ã‚·ã‚¹ãƒ†ãƒ ã®æ‹¡å¼µã§å¯¾å¿œå¯èƒ½ã§ã™ã€‚ä¿®æ­£ã•ã‚ŒãŸè¨­è¨ˆæ›¸ã«å¾“ã£ã¦å®Ÿè£…ã™ã‚Œã°ã€å®Œå…¨ã§å°†æ¥æ€§ã®ã‚ã‚‹è‡ªå‹•ä¿å­˜ã‚·ã‚¹ãƒ†ãƒ ãŒæ§‹ç¯‰ã§ãã¾ã™ã€‚

# çµ±ä¸€è‡ªå‹•ä¿å­˜ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸

## ğŸ“‹ **è¨­è¨ˆæ¦‚è¦**

**èª²é¡Œ**: ç¾åœ¨ã®ã—ã‚ƒã¹ã‚‹ãƒãƒ¼ãƒˆã§ã¯ã€ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ï¼ˆéŒ²éŸ³ãƒ»å†™çœŸã‚¹ã‚­ãƒ£ãƒ³ãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ»æ‰‹å‹•ä½œæˆï¼‰ã”ã¨ã«ç•°ãªã‚‹ä¿å­˜ã‚·ã‚¹ãƒ†ãƒ ãŒå­˜åœ¨ã—ã€ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½ã®ä¸€éƒ¨ã§è‡ªå‹•ä¿å­˜ãŒæ©Ÿèƒ½ã—ãªã„å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã‚‹ã€‚

**è§£æ±ºç­–**: å…¨ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã«å¯¾å¿œã—ãŸçµ±ä¸€çš„ãªãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–è‡ªå‹•ä¿å­˜ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã—ã€100%ã®ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½ã§ç¢ºå®Ÿãªè‡ªå‹•ä¿å­˜ã‚’å®Ÿç¾ã™ã‚‹ã€‚

---

## ğŸ¯ **è¨­è¨ˆç›®æ¨™**

### æ©Ÿèƒ½è¦ä»¶
- **100% ãƒ„ãƒ¼ãƒ«ãƒãƒ¼å¯¾å¿œ**: å…¨26å€‹ã®ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½ã§ç¢ºå®Ÿãªè‡ªå‹•ä¿å­˜
- **å…¨ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—å¯¾å¿œ**: recording/photo_scan/import/manual ã®4ç¨®é¡
- **5ç§’é–“éš”è‡ªå‹•ä¿å­˜**: ä¸€å®šé–“éš”ã§ã®ç¢ºå®Ÿãªä¿å­˜å®Ÿè¡Œ
- **å³åº§ä¿å­˜**: å¤‰æ›´æ¤œçŸ¥ã‹ã‚‰100msä»¥å†…ã§ã®ä¿å­˜ãƒ¬ã‚¹ãƒãƒ³ã‚¹
- **ç«¶åˆé˜²æ­¢**: è¤‡æ•°ä¿å­˜å‡¦ç†ã®åŒæ™‚å®Ÿè¡Œé˜²æ­¢

### éæ©Ÿèƒ½è¦ä»¶
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ä¿å­˜å‡¦ç†100msä»¥å†…ã€UIãƒ–ãƒ­ãƒƒã‚¯0ms
- **ä¿¡é ¼æ€§**: 99.9%ã®ä¿å­˜æˆåŠŸç‡ã€3æ®µéšãƒªãƒˆãƒ©ã‚¤
- **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: æ–°æ©Ÿèƒ½è¿½åŠ æ™‚ã®è‡ªå‹•å¯¾å¿œ
- **ä¿å®ˆæ€§**: çµ±ä¸€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ã‚ˆã‚‹ä½çµåˆè¨­è¨ˆ

---

## ğŸ—ï¸ **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ**

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³
```mermaid
graph TB
    UI[ãƒ„ãƒ¼ãƒ«ãƒãƒ¼UI] --> Hook[useAutoSave Hook]
    UI --> Decorator[AutoSaveDecorator]
    
    Decorator --> Hook
    Hook --> Service[UniversalNoteService]
    
    Service --> Recording[RecordingNote]
    Service --> PhotoScan[PhotoScanNote]
    Service --> Import[ImportNote]
    Service --> Manual[ManualNote]
    
    Recording --> SQLite[(SQLite DB)]
    PhotoScan --> SQLite
    Import --> SQLite
    Manual --> SQLite
    
    Hook --> Retry[RetryHandler]
    Retry --> Queue[SyncQueue]
```

### 4æ®µéšå®Ÿè£…æˆ¦ç•¥

#### **Phase 4.1: UniversalNoteå‹çµ±ä¸€ï¼ˆ2-3æ™‚é–“ï¼‰**
- å…¨ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã®å…±é€šãƒ‡ãƒ¼ã‚¿æ§‹é€ å®šç¾©
- å‹å®‰å…¨ãªå¤‰æ›ãƒ»æ¤œè¨¼é–¢æ•°å®Ÿè£…
- ãƒ‡ãƒ¼ã‚¿ä¸€è²«æ€§ç¢ºä¿

#### **Phase 4.2: useAutoSave Hookï¼ˆ3-4æ™‚é–“ï¼‰**
- ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–å¤‰æ›´æ¤œçŸ¥æ©Ÿèƒ½
- ãƒ‡ãƒã‚¦ãƒ³ã‚¹æ©Ÿèƒ½ï¼ˆ5ç§’é–“éš”ï¼‰
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼†ãƒªãƒˆãƒ©ã‚¤

#### **Phase 4.3: AutoSaveDecoratorï¼ˆ2-3æ™‚é–“ï¼‰**
- å…¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼é–¢æ•°ã¸ã®è‡ªå‹•é©ç”¨
- 100%ç¢ºå®Ÿãªå¤‰æ›´ãƒ•ãƒ©ã‚°è¨­å®š
- æœ€å°é™ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´

#### **Phase 4.4: çµ±ä¸€ä¿å­˜ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆ1-2æ™‚é–“ï¼‰**
- ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—åˆ¥ä¿å­˜å‡¦ç†çµ±åˆ
- ãƒ­ã‚°ãƒ»ç›£è¦–æ©Ÿèƒ½è¿½åŠ 
- æ—¢å­˜æ©Ÿèƒ½ã¨ã®äº’æ›æ€§ç¢ºä¿

---

## ğŸ“ **ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ**

### æ–°è¦ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«
```
app/
â”œâ”€â”€ types/
â”‚   â””â”€â”€ UniversalNote.ts           # çµ±ä¸€ãƒãƒ¼ãƒˆå‹å®šç¾©
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ useAutoSave.ts             # è‡ªå‹•ä¿å­˜ãƒ•ãƒƒã‚¯
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ AutoSaveDecorator.ts       # ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ‘ã‚¿ãƒ¼ãƒ³
â”œâ”€â”€ services/
â”‚   â””â”€â”€ UniversalNoteService.ts    # çµ±ä¸€ä¿å­˜ã‚µãƒ¼ãƒ“ã‚¹
â””â”€â”€ constants/
    â””â”€â”€ AutoSaveConfig.ts          # è¨­å®šå®šæ•°
```

### ä¿®æ­£å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
- `app/screens/CanvasEditor.tsx` - ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯é©ç”¨
- `app/services/database.ts` - ä¿å­˜é–¢æ•°çµ±åˆ
- `app/components/DrawingCanvas.tsx` - æç”»ã‚¤ãƒ™ãƒ³ãƒˆé€£æº

---

## ğŸ”§ **å®Ÿè£…è©³ç´°**

### 1. UniversalNoteå‹å®šç¾©
```typescript
// app/types/UniversalNote.ts
export interface UniversalNote {
  id: string;
  type: 'recording' | 'photo_scan' | 'import' | 'manual';
  title: string;
  canvasData: CanvasData;
  metadata: NoteMetadata;
  lastModified: string;
}

export interface CanvasData {
  type: 'canvas';
  version: '1.0';
  content: string;
  drawingPaths: DrawingPath[];
  canvasSettings: CanvasSettings;
}

export interface NoteMetadata {
  recordingId?: string;
  photoScanId?: string;
  importId?: string;
  duration?: number;
  fileSize?: number;
  originalFormat?: string;
}

// å‹å¤‰æ›ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
export const convertToUniversalNote = (
  note: Recording | PhotoScan | ImportFile,
  canvasData: CanvasData
): UniversalNote => {
  // å„ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã‹ã‚‰çµ±ä¸€å‹ã¸ã®å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯
};

// å‹å®‰å…¨ãªæ¤œè¨¼é–¢æ•°
export const validateUniversalNote = (note: any): note is UniversalNote => {
  // ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å‹æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯
};
```

### 2. useAutoSave Hook
```typescript
// app/hooks/useAutoSave.ts
export const useAutoSave = (noteId: string, noteType: NoteType) => {
  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [lastSaved, setLastSaved] = useState<Date | null>(null);
  const timerRef = useRef<NodeJS.Timeout | null>(null);
  
  // å¤‰æ›´ãƒ•ãƒ©ã‚°è¨­å®š
  const markAsChanged = useCallback(() => {
    console.log('ğŸ·ï¸ å¤‰æ›´ãƒ•ãƒ©ã‚°è¨­å®š: hasUnsavedChanges = true');
    setHasUnsavedChanges(true);
    
    // å³åº§ä¿å­˜ã®å®Ÿè£…
    if (!isSaving) {
      console.log('ğŸš€ å³åº§ã«è‡ªå‹•ä¿å­˜å®Ÿè¡Œ');
      performAutoSave();
    }
  }, [isSaving]);
  
  // è‡ªå‹•ä¿å­˜å®Ÿè¡Œ
  const performAutoSave = useCallback(async () => {
    if (isSaving || !hasUnsavedChanges) {
      console.log('ğŸ“ è‡ªå‹•ä¿å­˜ã‚¹ã‚­ãƒƒãƒ—:', { isSaving, hasUnsavedChanges });
      return;
    }
    
    try {
      setIsSaving(true);
      
      // çµ±ä¸€ä¿å­˜ã‚µãƒ¼ãƒ“ã‚¹å‘¼ã³å‡ºã—
      const universalNote = await buildUniversalNote(noteId, noteType);
      await UniversalNoteService.saveNote(universalNote);
      
      setHasUnsavedChanges(false);
      setLastSaved(new Date());
      console.log('âœ… è‡ªå‹•ä¿å­˜å®Œäº†');
      
    } catch (error) {
      console.log('âš ï¸ è‡ªå‹•ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      // 3æ®µéšãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½
      await handleSaveError(error);
    } finally {
      setIsSaving(false);
    }
  }, [noteId, noteType, isSaving, hasUnsavedChanges]);
  
  // 5ç§’é–“éš”ã®ã‚¿ã‚¤ãƒãƒ¼è¨­å®š
  useEffect(() => {
    timerRef.current = setInterval(() => {
      console.log('â° è‡ªå‹•ä¿å­˜ã‚¿ã‚¤ãƒãƒ¼å®Ÿè¡Œ');
      performAutoSave();
    }, 5000);
    
    return () => {
      if (timerRef.current) {
        clearInterval(timerRef.current);
      }
    };
  }, [performAutoSave]);
  
  return {
    markAsChanged,
    performAutoSave,
    hasUnsavedChanges,
    isSaving,
    lastSaved
  };
};
```

### 3. AutoSaveDecorator
```typescript
// app/utils/AutoSaveDecorator.ts
export const AutoSaveDecorator = <T extends Function>(
  originalFunction: T,
  autoSaveContext: { markAsChanged: () => void }
): T => {
  return ((...args: any[]) => {
    try {
      // å…ƒã®é–¢æ•°ã‚’å®Ÿè¡Œ
      const result = originalFunction(...args);
      
      // 100%ç¢ºå®Ÿã«å¤‰æ›´ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
      autoSaveContext.markAsChanged();
      
      return result;
    } catch (error) {
      console.error('âš ï¸ ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼:', error);
      // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚markAsChangedã¯å®Ÿè¡Œ
      autoSaveContext.markAsChanged();
      throw error;
    }
  }) as unknown as T;
};

// ä¸€æ‹¬ãƒ‡ã‚³ãƒ¬ãƒ¼ãƒˆé–¢æ•°
export const decorateAllHandlers = (
  handlers: Record<string, Function>,
  autoSaveContext: { markAsChanged: () => void }
): Record<string, Function> => {
  const decoratedHandlers: Record<string, Function> = {};
  
  Object.keys(handlers).forEach(key => {
    decoratedHandlers[key] = AutoSaveDecorator(handlers[key], autoSaveContext);
  });
  
  return decoratedHandlers;
};
```

### 4. UniversalNoteService
```typescript
// app/services/UniversalNoteService.ts
export class UniversalNoteService {
  static async saveNote(note: UniversalNote): Promise<void> {
    const startTime = Date.now();
    
    try {
      switch (note.type) {
        case 'recording':
          await this.saveRecordingNote(note);
          console.log('Canvas data updated successfully (recording)');
          break;
        case 'photo_scan':
          await this.savePhotoScanNote(note);
          console.log('Canvas data updated successfully (photo scan)');
          break;
        case 'import':
          await this.saveImportNote(note);
          console.log('Canvas data updated successfully (import)');
          break;
        case 'manual':
          await this.saveManualNote(note);
          console.log('Canvas data updated successfully (manual)');
          break;
      }
      
      const duration = Date.now() - startTime;
      console.log(`âœ… è‡ªå‹•ä¿å­˜å®Œäº†: ${duration}ms`, {
        contentLength: note.canvasData.content.length,
        pathsCount: note.canvasData.drawingPaths.length
      });
      
    } catch (error) {
      const duration = Date.now() - startTime;
      console.error(`âŒ è‡ªå‹•ä¿å­˜å¤±æ•—: ${duration}ms`, error);
      throw error;
    }
  }
  
  private static async saveRecordingNote(note: UniversalNote): Promise<void> {
    await updateCanvasData(note.id, note.canvasData);
  }
  
  private static async savePhotoScanNote(note: UniversalNote): Promise<void> {
    // å†™çœŸã‚¹ã‚­ãƒ£ãƒ³ç‰¹æœ‰ã®ä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯
    await updateCanvasData(note.id, note.canvasData);
  }
  
  private static async saveImportNote(note: UniversalNote): Promise<void> {
    // ã‚¤ãƒ³ãƒãƒ¼ãƒˆç‰¹æœ‰ã®ä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯
    await updateCanvasData(note.id, note.canvasData);
  }
  
  private static async saveManualNote(note: UniversalNote): Promise<void> {
    // æ‰‹å‹•ä½œæˆç‰¹æœ‰ã®ä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯
    await updateCanvasData(note.id, note.canvasData);
  }
}
```

---

## âœ… **å“è³ªä¿è¨¼æˆ¦ç•¥**

### è‡ªå‹•ãƒ†ã‚¹ãƒˆï¼ˆ100é …ç›®ï¼‰
```typescript
// å…¨ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ— Ã— å…¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
describe('çµ±ä¸€è‡ªå‹•ä¿å­˜ã‚·ã‚¹ãƒ†ãƒ ', () => {
  const NOTE_TYPES = ['recording', 'photo_scan', 'import', 'manual'];
  const TOOLBAR_FUNCTIONS = [
    // ãƒšãƒ³ãƒ„ãƒ¼ãƒ« (7é …ç›®)
    'pen_drawing', 'eraser_tool', 'marker_tool', 'media_upload',
    'ruler_tool', 'reading_ruler', 'pen_settings',
    
    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ„ãƒ¼ãƒ« (7é …ç›®)  
    'text_input', 'heading_change', 'font_change', 'font_size',
    'bold_toggle', 'line_spacing', 'letter_spacing',
    
    // ãã®ä»–ãƒ„ãƒ¼ãƒ« (4é …ç›®)
    'search_function', 'voice_operations', 'bookmark', 'settings',
    
    // AIãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ (7é …ç›®)
    'ai_summarize', 'ai_convert', 'ai_dictionary', 'ai_proofread',
    'ai_furigana', 'ai_research', 'ai_chat'
  ]; // è¨ˆ25é …ç›®
  
  NOTE_TYPES.forEach(noteType => {
    TOOLBAR_FUNCTIONS.forEach(toolbarFunction => {
      test(`${noteType}: ${toolbarFunction} ã§è‡ªå‹•ä¿å­˜`, async () => {
        // å„çµ„ã¿åˆã‚ã›ã§ã®è‡ªå‹•ä¿å­˜ãƒ†ã‚¹ãƒˆ
        const result = await testAutoSave(noteType, toolbarFunction);
        expect(result.saved).toBe(true);
        expect(result.responseTime).toBeLessThan(100); // 100msä»¥å†…
      });
    });
  });
});
```

### æ‰‹å‹•æ¤œè¨¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
```markdown
## éŒ²éŸ³ãƒãƒ¼ãƒˆè‡ªå‹•ä¿å­˜æ¤œè¨¼ (25é …ç›®)

### ãƒšãƒ³ãƒ„ãƒ¼ãƒ« (7é …ç›®)
- [ ] ãƒšãƒ³ã¨é‰›ç­†ã®åˆ‡ã‚Šæ›¿ãˆã¨æç”»
- [ ] æ¶ˆã—ã‚´ãƒ ä½¿ç”¨
- [ ] ãƒãƒ¼ã‚«ãƒ¼æç”»
- [ ] ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆç”»åƒæŒ¿å…¥ï¼‰
- [ ] å®šè¦æ©Ÿèƒ½
- [ ] ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ«ãƒ¼ãƒ©ãƒ¼æ©Ÿèƒ½
- [ ] ãƒšãƒ³ã®å¤ªã•ã¨è‰²ã®å¤‰æ›´

### ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ„ãƒ¼ãƒ« (7é …ç›®)
- [ ] ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›
- [ ] è¦‹å‡ºã—1ã€2ã€3ã€æœ¬æ–‡å¤‰æ›´
- [ ] ãƒ•ã‚©ãƒ³ãƒˆå¤‰æ›´
- [ ] ã‚µã‚¤ã‚ºå¤‰æ›´
- [ ] å¤ªå­—åˆ‡ã‚Šæ›¿ãˆ
- [ ] è¡Œé–“å¤‰æ›´
- [ ] æ–‡å­—é–“ã®é–“éš”å¤‰æ›´

### ãã®ä»–ãƒ„ãƒ¼ãƒ« (4é …ç›®)
- [ ] æ¤œç´¢æ©Ÿèƒ½
- [ ] éŸ³å£°éŒ²éŸ³ã€å†ç”Ÿã€ä¸€æ™‚åœæ­¢ã€åœæ­¢
- [ ] ã—ãŠã‚Šæ©Ÿèƒ½
- [ ] è¨­å®šï¼ˆãƒšãƒ¼ã‚¸è¨­å®šç­‰ï¼‰

### AIãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ (7é …ç›®)
- [ ] è¦ç´„æ©Ÿèƒ½
- [ ] æ¼¢å­—ã€ã‚«ã‚¿ã‚«ãƒŠã€ã²ã‚‰ãŒãªã«å¤‰æ›æ©Ÿèƒ½
- [ ] è¾æ›¸æ©Ÿèƒ½
- [ ] æ ¡æ­£æ©Ÿèƒ½
- [ ] ãµã‚ŠãŒãªã‚’æŒ¯ã‚‹æ©Ÿèƒ½
- [ ] ãƒªã‚µãƒ¼ãƒæ©Ÿèƒ½
- [ ] é€šå¸¸ãƒãƒ£ãƒƒãƒˆã¨éŸ³å£°å…¥åŠ›å¯¾å¿œ

## å†™çœŸã‚¹ã‚­ãƒ£ãƒ³ãƒãƒ¼ãƒˆè‡ªå‹•ä¿å­˜æ¤œè¨¼ (25é …ç›®)
[åŒæ§˜ã®é …ç›®ã‚’ãƒªã‚¹ãƒˆåŒ–]

## ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒãƒ¼ãƒˆè‡ªå‹•ä¿å­˜æ¤œè¨¼ (25é …ç›®)
[åŒæ§˜ã®é …ç›®ã‚’ãƒªã‚¹ãƒˆåŒ–]

## æ‰‹å‹•ãƒãƒ¼ãƒˆè‡ªå‹•ä¿å­˜æ¤œè¨¼ (25é …ç›®)
[åŒæ§˜ã®é …ç›®ã‚’ãƒªã‚¹ãƒˆåŒ–]
```

---

## ğŸ”„ **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**

### 3æ®µéšãƒªãƒˆãƒ©ã‚¤ãƒ¡ã‚«ãƒ‹ã‚ºãƒ 
```typescript
interface SaveRetryPolicy {
  maxRetries: 3;
  backoffIntervals: [1000, 3000, 10000]; // 1ç§’ã€3ç§’ã€10ç§’
  fallbackActions: [
    'immediate_retry',    // 1å›ç›®: ã™ããƒªãƒˆãƒ©ã‚¤
    'queue_for_sync',     // 2å›ç›®: åŒæœŸã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
    'local_only_save'     // 3å›ç›®: ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã®ã¿
  ];
}

const handleSaveError = async (error: Error, attempt: number = 1) => {
  if (attempt <= 3) {
    console.log(`ğŸ”„ è‡ªå‹•ä¿å­˜ãƒªãƒˆãƒ©ã‚¤ ${attempt}/3:`, error.message);
    
    // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§ã®å¾…æ©Ÿ
    await new Promise(resolve => 
      setTimeout(resolve, RETRY_POLICY.backoffIntervals[attempt - 1])
    );
    
    try {
      await performAutoSave();
    } catch (retryError) {
      return handleSaveError(retryError, attempt + 1);
    }
  } else {
    // æœ€çµ‚çš„ã«ã¯åŒæœŸã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã—ã¦å¾Œã§å‡¦ç†
    console.log('âš ï¸ è‡ªå‹•ä¿å­˜æœ€çµ‚å¤±æ•— - åŒæœŸã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ');
    await addToSyncQueue(noteData);
  }
};
```

---

## ğŸ“Š **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**

### å¿œç­”æ™‚é–“ç›®æ¨™
- **å³åº§ä¿å­˜**: å¤‰æ›´æ¤œçŸ¥ã‹ã‚‰100msä»¥å†…
- **å®šæœŸä¿å­˜**: 5ç§’é–“éš”ã€50msä»¥å†…ã§å®Œäº†
- **UIãƒ–ãƒ­ãƒƒã‚¯**: 0msï¼ˆéåŒæœŸå‡¦ç†ï¼‰

### ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡
- **æœ€å¤§ã‚­ãƒ¥ãƒ¼ã‚µã‚¤ã‚º**: 3ä»¶ã®ä¿å­˜å‡¦ç†ã¾ã§ä¸¦åˆ—å®Ÿè¡Œ
- **ãƒ‡ãƒã‚¦ãƒ³ã‚¹**: é€£ç¶šå¤‰æ›´ã®çµ±åˆå‡¦ç†
- **ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³**: ä¸è¦ãªä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•å‰Šé™¤

---

## ğŸš€ **å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«**

| Phase | å†…å®¹ | æ‰€è¦æ™‚é–“ | å®Ÿè£…é †åº |
|-------|------|----------|----------|
| 4.1 | UniversalNoteå‹çµ±ä¸€ | 2-3æ™‚é–“ | 1ï¸âƒ£ |
| 4.2 | useAutoSave Hook | 3-4æ™‚é–“ | 2ï¸âƒ£ |
| 4.3 | AutoSaveDecorator | 2-3æ™‚é–“ | 3ï¸âƒ£ |
| 4.4 | çµ±ä¸€ä¿å­˜ã‚µãƒ¼ãƒ“ã‚¹ | 1-2æ™‚é–“ | 4ï¸âƒ£ |
| QA | å“è³ªä¿è¨¼ãƒ»ãƒ†ã‚¹ãƒˆ | 2-3æ™‚é–“ | 5ï¸âƒ£ |

**ç·è¨ˆ**: 10-15æ™‚é–“ï¼ˆ1.5-2æ—¥é–“ï¼‰

**å®Œäº†åŸºæº–**: 
- âœ… å…¨25ç¨®é¡ã®ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½ã§è‡ªå‹•ä¿å­˜å‹•ä½œ
- âœ… å…¨4ç¨®é¡ã®ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã§çµ±ä¸€å‹•ä½œ
- âœ… 100é …ç›®ã®æ‰‹å‹•æ¤œè¨¼å®Œäº†
- âœ… 100msä»¥å†…ã®ä¿å­˜å¿œç­”æ™‚é–“é”æˆ
- âœ… æ–°æ©Ÿèƒ½è¿½åŠ æ™‚ã®è‡ªå‹•å¯¾å¿œç¢ºèª

---

ã“ã®è¨­è¨ˆæ›¸ã«å¾“ã£ã¦å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€è‡ªå‹•ä¿å­˜å•é¡Œã‚’æ ¹æœ¬çš„ã«è§£æ±ºã—ã€å°†æ¥çš„ãªæ©Ÿèƒ½è¿½åŠ ã«ã‚‚è‡ªå‹•å¯¾å¿œã™ã‚‹æ‹¡å¼µæ€§ã®é«˜ã„ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚

---

## ğŸ¤– **AIãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½çµ±åˆä»•æ§˜**

### AIãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã¨çµ±ä¸€è‡ªå‹•ä¿å­˜ã‚·ã‚¹ãƒ†ãƒ ã®çµ±åˆ

AIãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ï¼ˆè¦ç´„ãƒ»æ ¡æ­£ãƒ»èª­ã¿ä»®åãƒ»æ–‡å­—å¤‰æ›ãƒ»ãƒªã‚µãƒ¼ãƒãƒ»è¾æ›¸ï¼‰ã¯çµ±ä¸€è‡ªå‹•ä¿å­˜ã‚·ã‚¹ãƒ†ãƒ ã«å®Œå…¨çµ±åˆã•ã‚Œã¾ã™ã€‚

#### A. AIæ©Ÿèƒ½å®Ÿè¡Œæ™‚ã®ä¿å­˜ãƒ•ãƒ­ãƒ¼

**1. AIå‡¦ç†å®Ÿè¡Œå‰**
```typescript
// AIChatWidget.tsx ã§ã®å‡¦ç†é–‹å§‹
const handleAIFunction = async (functionType: AIFunction) => {
  try {
    // Step 1: AIå‡¦ç†é–‹å§‹ãƒ•ãƒ©ã‚°è¨­å®š
    setIsAIProcessing(true);
    setAIProcessingType(functionType);
    
    // Step 2: ç¾åœ¨ã®ã‚­ãƒ£ãƒ³ãƒã‚¹çŠ¶æ…‹ã‚’AIã«é€ä¿¡
    const currentCanvas = {
      textContent: canvasText,
      selectedText: selectedText,
      drawingPaths: drawingPaths
    };
    
    // Step 3: AI APIã‚³ãƒ¼ãƒ«
    const result = await callAIAPI(`/ai/${functionType}`, currentCanvas);
    
    // Step 4: AIå‡¦ç†çµæœã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«åæ˜ 
    if (onTextUpdate && result.processedText) {
      onTextUpdate(result.processedText); // â†’ setContent() â†’ markAsChanged()
    }
    
  } finally {
    setIsAIProcessing(false);
    setAIProcessingType(null);
  }
};
```

**2. ã‚­ãƒ£ãƒ³ãƒã‚¹æ›´æ–°ã¨è‡ªå‹•ä¿å­˜é€£æº**
```typescript
// CanvasEditor.tsx ã§ã®å‡¦ç†
<AIChatWidget
  canvasText={content}
  selectedText={selectedText}
  onTextUpdate={(newText) => {
    // Step 1: ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
    setContent(newText);
    
    // Step 2: ğŸ”¥ çµ±ä¸€è‡ªå‹•ä¿å­˜ã‚·ã‚¹ãƒ†ãƒ é€£æº
    markAsChanged(); // useAutoSave HookçµŒç”±
    
    // Step 3: Undo/Redoã‚¹ã‚¿ãƒƒã‚¯æ›´æ–°
    addToUndoStack({
      type: 'ai_text_update',
      previousText: content,
      newText: newText,
      timestamp: Date.now()
    });
  }}
/>
```

#### B. AIå‡¦ç†ä¸­ã®ç«¶åˆé˜²æ­¢

**1. è‡ªå‹•ä¿å­˜ã¨ã®ç«¶åˆé˜²æ­¢**
```typescript
// useAutoSave.ts ã§ã®ç«¶åˆåˆ¶å¾¡
const performAutoSave = useCallback(async () => {
  // AIå‡¦ç†ä¸­ã¯è‡ªå‹•ä¿å­˜ã‚’å„ªå…ˆå®Ÿè¡Œ
  if (isAIProcessing) {
    console.log('ğŸ¤– AIå‡¦ç†ä¸­: è‡ªå‹•ä¿å­˜ã‚’å„ªå…ˆå®Ÿè¡Œ');
    // AIå‡¦ç†å®Œäº†ã‚’å¾…ãŸãšã«ç¾åœ¨ã®çŠ¶æ…‹ã‚’ä¿å­˜
  }
  
  if (isSaving) {
    console.log('â³ è‡ªå‹•ä¿å­˜ä¸­: AIå‡¦ç†ã‚’ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°');
    return; // ä¿å­˜å‡¦ç†ä¸­ã¯ã‚¹ã‚­ãƒƒãƒ—
  }
  
  // é€šå¸¸ã®è‡ªå‹•ä¿å­˜å‡¦ç†
}, [isAIProcessing, isSaving]);
```

**2. åŒæ™‚ç·¨é›†é˜²æ­¢**
```typescript
// AIChatWidget.tsx ã§ã®ç·¨é›†ãƒ­ãƒƒã‚¯
const [isEditingLocked, setIsEditingLocked] = useState(false);

useEffect(() => {
  if (isAIProcessing) {
    // AIå‡¦ç†ä¸­ã¯ã‚­ãƒ£ãƒ³ãƒã‚¹ç·¨é›†ã‚’ç„¡åŠ¹åŒ–
    setIsEditingLocked(true);
    
    // è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    showAIProcessingOverlay();
  } else {
    setIsEditingLocked(false);
    hideAIProcessingOverlay();
  }
}, [isAIProcessing]);
```

#### C. Undo/Redoå¯¾å¿œ

**1. AIå¤‰æ›´ã®å±¥æ­´ç®¡ç†**
```typescript
// AIå‡¦ç†çµæœã®Undo/Redoã‚¹ã‚¿ãƒƒã‚¯è¿½åŠ 
interface AIUndoAction {
  type: 'ai_action';
  functionType: AIFunction; // 'summarize' | 'proofread' | 'furigana' etc.
  beforeState: {
    textContent: string;
    drawingPaths: DrawingPath[];
    canvasSettings: CanvasSettings;
  };
  afterState: {
    textContent: string;
    drawingPaths: DrawingPath[];
    canvasSettings: CanvasSettings;
  };
  timestamp: number;
  isReversible: boolean; // AIå‡¦ç†ã¯å¸¸ã«true
}

const handleAIUndo = (action: AIUndoAction) => {
  // AIå‡¦ç†å‰ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
  setContent(action.beforeState.textContent);
  setDrawingPaths(action.beforeState.drawingPaths);
  
  // å¾©å…ƒå¾Œã«è‡ªå‹•ä¿å­˜å®Ÿè¡Œ
  markAsChanged();
  
  console.log(`ğŸ”™ AIå‡¦ç†Undoå®Ÿè¡Œ: ${action.functionType}`);
};
```

**2. AIå‡¦ç†ã®æ®µéšçš„Undo**
```typescript
// è¤‡æ•°ã®AIå‡¦ç†ã‚’å€‹åˆ¥ã«Undoå¯èƒ½
const undoStack: UndoAction[] = [
  { type: 'text_edit', content: 'å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ' },
  { type: 'ai_action', functionType: 'summarize', beforeState: {...}, afterState: {...} },
  { type: 'ai_action', functionType: 'furigana', beforeState: {...}, afterState: {...} },
  { type: 'drawing', drawingPaths: [...] }
];

// æœ€å¾Œã®AIå‡¦ç†ã®ã¿ã‚’Undo
const undoLastAIAction = () => {
  const lastAIAction = undoStack.findLast(action => action.type === 'ai_action');
  if (lastAIAction) {
    handleAIUndo(lastAIAction as AIUndoAction);
  }
};
```

#### D. ãƒ‡ãƒ¼ã‚¿å½¢å¼ã®æ•´åˆæ€§

**1. AIãƒãƒ£ãƒƒãƒˆå‡¦ç†ã®ãƒ‡ãƒ¼ã‚¿å¤‰æ›**
```typescript
// æ‰‹æ›¸ãâ†’ãƒ†ã‚­ã‚¹ãƒˆâ†’AIå‡¦ç†â†’ä¿å­˜ã®ä¸€é€£ãƒ•ãƒ­ãƒ¼
interface AIProcessingFlow {
  input: {
    type: 'handwriting' | 'text' | 'mixed';
    handwritingPaths?: DrawingPath[];
    textContent?: string;
    selectedRange?: { start: number; end: number };
  };
  processing: {
    step1_ocr?: string; // æ‰‹æ›¸ãã®å ´åˆã®OCRçµæœ
    step2_ai_input: string; // AIå‡¦ç†ã«é€ã‚‰ã‚Œã‚‹ãƒ†ã‚­ã‚¹ãƒˆ
    step3_ai_output: string; // AIå‡¦ç†çµæœ
  };
  output: {
    type: 'canvas';
    version: '1.0';
    content: string; // AIå‡¦ç†å¾Œã®ãƒ†ã‚­ã‚¹ãƒˆ
    drawingPaths: DrawingPath[]; // æ‰‹æ›¸ããƒ‡ãƒ¼ã‚¿ã¯ä¿æŒ
    aiProcessingHistory: AIProcessingRecord[];
  };
}

interface AIProcessingRecord {
  functionType: AIFunction;
  inputText: string;
  outputText: string;
  confidence: number;
  timestamp: string;
  processingTime: number; // ms
}
```

**2. æ··åœ¨ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†**
```typescript
// æ‰‹æ›¸ã+ãƒ†ã‚­ã‚¹ãƒˆæ··åœ¨æ™‚ã®AIå‡¦ç†
const processeMixedContent = async (
  textContent: string,
  drawingPaths: DrawingPath[],
  aiFunction: AIFunction
): Promise<ProcessedContent> => {
  
  // Step 1: æ‰‹æ›¸ããƒ‡ãƒ¼ã‚¿ã‚’OCRã§ãƒ†ã‚­ã‚¹ãƒˆåŒ–ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰
  const handwritingText = await extractTextFromPaths(drawingPaths);
  
  // Step 2: ãƒ†ã‚­ã‚¹ãƒˆ+æ‰‹æ›¸ããƒ†ã‚­ã‚¹ãƒˆã‚’çµåˆ
  const combinedText = `${textContent}\n${handwritingText}`;
  
  // Step 3: AIå‡¦ç†å®Ÿè¡Œ
  const aiResult = await executeAIFunction(aiFunction, combinedText);
  
  // Step 4: çµæœã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹å½¢å¼ã§è¿”å´
  return {
    processedText: aiResult,
    originalDrawingPaths: drawingPaths, // æ‰‹æ›¸ããƒ‡ãƒ¼ã‚¿ã¯ä¿æŒ
    processingMetadata: {
      hadHandwriting: drawingPaths.length > 0,
      ocrConfidence: handwritingText ? 0.95 : null,
      aiFunction: aiFunction
    }
  };
};
```

#### E. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

**1. AIå‡¦ç†ã®éåŒæœŸå®Ÿè¡Œ**
```typescript
// AIå‡¦ç†ä¸­ã‚‚è‡ªå‹•ä¿å­˜ã¯ç¶™ç¶šå®Ÿè¡Œ
const [aiProcessingQueue, setAIProcessingQueue] = useState<AITask[]>([]);

const executeAITasksInBackground = async () => {
  while (aiProcessingQueue.length > 0) {
    const task = aiProcessingQueue[0];
    
    try {
      // AIå‡¦ç†å®Ÿè¡Œï¼ˆéãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰
      const result = await processAITask(task);
      
      // çµæœé©ç”¨
      applyAIResult(result);
      
      // ğŸ”¥ AIå‡¦ç†å®Œäº†å¾Œã«è‡ªå‹•ä¿å­˜
      markAsChanged();
      
    } catch (error) {
      console.error('ğŸ¤– AIå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
    } finally {
      // ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å‰Šé™¤
      setAIProcessingQueue(prev => prev.slice(1));
    }
  }
};
```

**2. AIçµæœã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½**
```typescript
// åŒä¸€ãƒ†ã‚­ã‚¹ãƒˆã®AIå‡¦ç†çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
interface AICache {
  [key: string]: { // MD5ãƒãƒƒã‚·ãƒ¥ã‚’ã‚­ãƒ¼ã¨ã™ã‚‹
    functionType: AIFunction;
    inputHash: string;
    result: string;
    timestamp: number;
    expiry: number; // 1æ™‚é–“å¾Œã«æœŸé™åˆ‡ã‚Œ
  };
}

const getCachedAIResult = (
  inputText: string, 
  functionType: AIFunction
): string | null => {
  const hash = generateHash(inputText + functionType);
  const cached = aiCache[hash];
  
  if (cached && Date.now() < cached.expiry) {
    console.log('ğŸš€ AIçµæœã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ:', functionType);
    return cached.result;
  }
  
  return null;
};
```

#### F. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

**1. AI APIå¤±æ•—æ™‚ã®ä¿å­˜å‡¦ç†**
```typescript
const handleAIError = async (error: Error, context: AIContext) => {
  console.error('ğŸ¤– AIå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
  
  // Step 1: ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã«è¨˜éŒ²
  const errorMetadata = {
    error: error.message,
    functionType: context.functionType,
    inputLength: context.inputText.length,
    timestamp: Date.now(),
    retryCount: context.retryCount || 0
  };
  
  // Step 2: ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã§ã‚‚è‡ªå‹•ä¿å­˜å®Ÿè¡Œï¼ˆãƒ‡ãƒ¼ã‚¿æå¤±é˜²æ­¢ï¼‰
  await markAsChanged();
  
  // Step 3: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€šçŸ¥ï¼ˆUIå±¤ï¼‰
  showAIErrorNotification(error, context.functionType);
  
  // Step 4: è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ï¼ˆæœ€å¤§3å›ï¼‰
  if (context.retryCount < 3) {
    setTimeout(() => {
      retryAIProcessing(context);
    }, 2000 * (context.retryCount + 1)); // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•
  }
};
```

#### G. ãƒ†ã‚¹ãƒˆä»•æ§˜

**1. AIçµ±åˆæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹**
```typescript
describe('AI Chat Widget Auto Save Integration', () => {
  test('AIè¦ç´„å®Ÿè¡Œå¾Œã«è‡ªå‹•ä¿å­˜ãŒå®Ÿè¡Œã•ã‚Œã‚‹', async () => {
    // AIè¦ç´„å®Ÿè¡Œ
    await executeAIFunction('summarize', 'ãƒ†ã‚¹ãƒˆãƒ†ã‚­ã‚¹ãƒˆ');
    
    // markAsChangedãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
    expect(mockMarkAsChanged).toHaveBeenCalledTimes(1);
    
    // è‡ªå‹•ä¿å­˜ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
    await waitFor(() => {
      expect(mockPerformAutoSave).toHaveBeenCalled();
    });
  });
  
  test('AIå‡¦ç†ä¸­ã§ã‚‚è‡ªå‹•ä¿å­˜ã¯å®Ÿè¡Œã•ã‚Œã‚‹', async () => {
    // AIå‡¦ç†é–‹å§‹ï¼ˆé•·æ™‚é–“å‡¦ç†ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼‰
    const aiPromise = executeAIFunction('research', 'ã‚¯ã‚¨ãƒª');
    
    // æ‰‹å‹•ã§ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›´
    await changeCanvasText('æ–°ã—ã„ãƒ†ã‚­ã‚¹ãƒˆ');
    
    // AIå‡¦ç†ä¸­ã§ã‚‚è‡ªå‹•ä¿å­˜ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
    expect(mockPerformAutoSave).toHaveBeenCalled();
    
    await aiPromise;
  });
  
  test('AIå‡¦ç†çµæœã®Undo/RedoãŒæ­£å¸¸å‹•ä½œã™ã‚‹', async () => {
    const originalText = 'å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ';
    const summarizedText = 'AIãŒè¦ç´„ã—ãŸãƒ†ã‚­ã‚¹ãƒˆ';
    
    // è¦ç´„å®Ÿè¡Œ
    await executeAIFunction('summarize', originalText);
    expect(getCurrentCanvasText()).toBe(summarizedText);
    
    // Undoå®Ÿè¡Œ
    await executeUndo();
    expect(getCurrentCanvasText()).toBe(originalText);
    
    // Redoå®Ÿè¡Œ
    await executeRedo();
    expect(getCurrentCanvasText()).toBe(summarizedText);
  });
});
```

---

## ğŸ“„ **ãƒšãƒ¼ã‚¸ç®¡ç†æ©Ÿèƒ½çµ±åˆå¯¾å¿œ**

### ç¾åœ¨ã®å®Ÿè£…çŠ¶æ³ã¨èª²é¡Œ

#### **ç¾åœ¨ã®å†™çœŸã‚¹ã‚­ãƒ£ãƒ³ä»•æ§˜**
- **SQLiteå®Ÿè£…**: è¤‡æ•°å†™çœŸã‚’1ã¤ã®`PhotoScan`ãƒ¬ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ä¿å­˜
- **ãƒšãƒ¼ã‚¸æ¦‚å¿µãªã—**: å†™çœŸé…åˆ—ã¨ã—ã¦ç®¡ç†ï¼ˆ`photos[]`ï¼‰
- **è‡ªå‹•ä¿å­˜å¯¾è±¡**: PhotoScanãƒ¬ã‚³ãƒ¼ãƒ‰å…¨ä½“

#### **å°†æ¥ã®ãƒšãƒ¼ã‚¸è¿½åŠ æ©Ÿèƒ½ä»•æ§˜**
- **PostgreSQLç§»è¡Œ**: è¤‡æ•°å†™çœŸ â†’ è¤‡æ•°`pages`ãƒ¬ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ä¿å­˜
- **ãƒšãƒ¼ã‚¸æ¦‚å¿µã‚ã‚Š**: å„å†™çœŸãŒç‹¬ç«‹ã—ãŸãƒšãƒ¼ã‚¸ï¼ˆ`page_number`é †åºç®¡ç†ï¼‰
- **è‡ªå‹•ä¿å­˜å¯¾è±¡**: å„ãƒšãƒ¼ã‚¸ã®`canvas_data`å€‹åˆ¥ç®¡ç†

### çµ±ä¸€è‡ªå‹•ä¿å­˜ã‚·ã‚¹ãƒ†ãƒ ã®æ‹¡å¼µè¨­è¨ˆ

#### **1. UniversalNoteå‹ã®è¤‡æ•°ãƒšãƒ¼ã‚¸å¯¾å¿œè¨­è¨ˆ**
```typescript
// Phase 4.1ã§ã®è¤‡æ•°ãƒšãƒ¼ã‚¸å¯¾å¿œå‹å®šç¾©
export interface UniversalNote {
  id: string;
  type: 'recording' | 'photo_scan' | 'import' | 'manual';
  title: string;
  
  // ğŸ†• å¸¸ã«è¤‡æ•°ãƒšãƒ¼ã‚¸æ§‹é€ ï¼ˆ1ãƒšãƒ¼ã‚¸ã§ã‚‚é…åˆ—ï¼‰
  pages: Array<{
    pageId: string;
    pageNumber: number;
    canvasData: CanvasData;
    lastModified: string;
    
    // ãƒšãƒ¼ã‚¸å›ºæœ‰ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    pageMetadata?: {
      // éŒ²éŸ³ãƒãƒ¼ãƒˆç”¨
      audioTimestamp?: { start: number; end: number };
      transcriptText?: string;
      
      // å†™çœŸã‚¹ã‚­ãƒ£ãƒ³ç”¨
      photoUri?: string;
      ocrResult?: OCRResult;
      
      // ã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨
      sourcePageNumber?: number;
      sourceUri?: string;
      
      // æ‰‹å‹•ãƒãƒ¼ãƒˆç”¨
      isManuallyCreated?: boolean;
    };
  }>;
  
  // ç¾åœ¨è¡¨ç¤ºä¸­ã®ãƒšãƒ¼ã‚¸æƒ…å ±
  currentPage: {
    pageId: string;
    pageNumber: number;
  };
  
  // ãƒãƒ¼ãƒˆå…¨ä½“ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  metadata: NoteMetadata & {
    totalPages: number;
    autoSplitEnabled: boolean; // è‡ªå‹•ãƒšãƒ¼ã‚¸åˆ†å‰²æœ‰åŠ¹/ç„¡åŠ¹
    maxCharactersPerPage?: number; // ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šæœ€å¤§æ–‡å­—æ•°
  };
  
  lastModified: string;
}

// ğŸ†• ãƒšãƒ¼ã‚¸ä½œæˆæ™‚ã®å‹å®šç¾©
export interface PageCreateData {
  pageNumber?: number; // æŒ‡å®šã—ãªã„å ´åˆã¯æœ«å°¾ã«è¿½åŠ 
  canvasData?: CanvasData;
  pageMetadata?: UniversalNote['pages'][0]['pageMetadata'];
}

// ğŸ†• è‡ªå‹•ãƒšãƒ¼ã‚¸åˆ†å‰²ã®è¨­å®š
export interface AutoSplitConfig {
  enabled: boolean;
  maxCharactersPerPage: number;
  splitBoundary: 'sentence' | 'paragraph' | 'character';
  preserveStructure: boolean; // è¦‹å‡ºã—ãªã©ã®æ§‹é€ ã‚’ä¿æŒ
}
```

#### **2. useAutoSave Hookï¼ˆè¤‡æ•°ãƒšãƒ¼ã‚¸å¯¾å¿œï¼‰**
```typescript
// è¤‡æ•°ãƒšãƒ¼ã‚¸å¯¾å¿œã®çµ±ä¸€è‡ªå‹•ä¿å­˜Hook
export const useAutoSave = (
  noteId: string, 
  noteType: NoteType,
  options?: {
    currentPageId: string;     // ğŸ†• å¿…é ˆï¼šç¾åœ¨ç·¨é›†ä¸­ã®ãƒšãƒ¼ã‚¸ID
    autoSplitEnabled?: boolean; // ğŸ†• è‡ªå‹•ãƒšãƒ¼ã‚¸åˆ†å‰²æœ‰åŠ¹/ç„¡åŠ¹
    maxCharactersPerPage?: number; // ğŸ†• ãƒšãƒ¼ã‚¸åˆ†å‰²ã®é–¾å€¤
  }
) => {
  // ğŸ†• ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿å–å¾—
  const getCurrentPageData = useCallback(async (): Promise<{
    canvasData: CanvasData;
    textContent: string;
    characterCount: number;
  }> => {
    // CanvasEditorã‹ã‚‰ç¾åœ¨ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const canvasData = getCurrentCanvasData();
    const textContent = extractTextFromCanvas(canvasData);
    
    return {
      canvasData,
      textContent,
      characterCount: textContent.length
    };
  }, []);
  
  // ğŸ†• è‡ªå‹•ãƒšãƒ¼ã‚¸åˆ†å‰²ãƒã‚§ãƒƒã‚¯
  const checkAutoSplit = useCallback(async (pageData: any) => {
    if (!options?.autoSplitEnabled || !options?.maxCharactersPerPage) {
      return false;
    }
    
    return pageData.characterCount > options.maxCharactersPerPage;
  }, [options]);
  
  // ğŸ†• ãƒšãƒ¼ã‚¸åˆ†å‰²å®Ÿè¡Œ
  const performAutoSplit = useCallback(async (pageData: any) => {
    const splitResult = await UniversalNoteService.splitPage(
      noteId,
      options!.currentPageId,
      pageData.textContent,
      {
        maxCharactersPerPage: options!.maxCharactersPerPage!,
        splitBoundary: 'paragraph'
      }
    );
    
    console.log(`ğŸ“„ è‡ªå‹•ãƒšãƒ¼ã‚¸åˆ†å‰²å®Ÿè¡Œ: ${splitResult.newPages.length}ãƒšãƒ¼ã‚¸ã«åˆ†å‰²`);
    return splitResult;
  }, [noteId, options]);
  
  // ğŸ†• è¤‡æ•°ãƒšãƒ¼ã‚¸å¯¾å¿œä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯
  const performAutoSave = useCallback(async () => {
    if (isSaving) {
      console.log('ğŸ”„ ä¿å­˜å‡¦ç†ä¸­ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
      return;
    }
    
    try {
      setIsSaving(true);
      
      // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const pageData = await getCurrentPageData();
      
      // è‡ªå‹•ãƒšãƒ¼ã‚¸åˆ†å‰²ãƒã‚§ãƒƒã‚¯
      const needsSplit = await checkAutoSplit(pageData);
      
      if (needsSplit) {
        // ãƒšãƒ¼ã‚¸åˆ†å‰²å®Ÿè¡Œ
        const splitResult = await performAutoSplit(pageData);
        
        // åˆ†å‰²å¾Œã®æœ€åˆã®ãƒšãƒ¼ã‚¸ã«ç§»å‹•
        setCurrentPageId(splitResult.newPages[0].pageId);
      } else {
        // é€šå¸¸ã®å˜ä¸€ãƒšãƒ¼ã‚¸ä¿å­˜
        await UniversalNoteService.savePageOnly(
          noteId,
          options!.currentPageId,
          pageData.canvasData
        );
      }
      
      console.log('âœ… è¤‡æ•°ãƒšãƒ¼ã‚¸å¯¾å¿œè‡ªå‹•ä¿å­˜å®Œäº†');
      
    } catch (error) {
      console.error('âŒ è‡ªå‹•ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
    } finally {
      setIsSaving(false);
    }
  }, [noteId, options, isSaving]);
  
  // ğŸ†• ãƒšãƒ¼ã‚¸è¿½åŠ 
  const addNewPage = useCallback(async (
    pageData?: PageCreateData
  ) => {
    const newPage = await UniversalNoteService.addPage(noteId, pageData);
    setCurrentPageId(newPage.pageId);
    console.log(`ğŸ“„ æ–°ãƒšãƒ¼ã‚¸è¿½åŠ : ${newPage.pageNumber}ãƒšãƒ¼ã‚¸ç›®`);
    return newPage;
  }, [noteId]);
  
  // ğŸ†• ãƒšãƒ¼ã‚¸ç§»å‹•
  const navigateToPage = useCallback(async (pageNumber: number) => {
    const targetPage = await UniversalNoteService.getPageByNumber(noteId, pageNumber);
    if (targetPage) {
      setCurrentPageId(targetPage.pageId);
      console.log(`ğŸ“„ ãƒšãƒ¼ã‚¸ç§»å‹•: ${pageNumber}ãƒšãƒ¼ã‚¸ç›®`);
    }
  }, [noteId]);
  
  // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯
  useEffect(() => {
    const timer = setInterval(performAutoSave, AUTO_SAVE_INTERVAL);
    return () => clearInterval(timer);
  }, [performAutoSave]);
  
  return {
    performAutoSave,
    addNewPage,
    navigateToPage,
    isSaving,
    markAsChanged: () => setHasUnsavedChanges(true)
  };
};
```

#### **3. UniversalNoteServiceï¼ˆè¤‡æ•°ãƒšãƒ¼ã‚¸å¯¾å¿œï¼‰**
```typescript
export class UniversalNoteService {
  // ğŸ†• ãƒãƒ¼ãƒˆå…¨ä½“ä¿å­˜ï¼ˆè¤‡æ•°ãƒšãƒ¼ã‚¸å¯¾å¿œï¼‰
  static async saveNote(note: UniversalNote): Promise<void> {
    const operations = [];
    
    for (const page of note.pages) {
      operations.push(this.savePageOnly(note.id, page.pageId, page.canvasData));
    }
    
    // ä¸¦åˆ—ä¿å­˜ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
    await Promise.all(operations);
    
    // ãƒãƒ¼ãƒˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ›´æ–°
    await this.updateNoteMetadata(note.id, note.metadata);
  }
  
  // ğŸ†• ç‰¹å®šãƒšãƒ¼ã‚¸ã®ã¿ä¿å­˜
  static async savePageOnly(
    noteId: string, 
    pageId: string, 
    canvasData: CanvasData
  ): Promise<void> {
    const note = await this.getNote(noteId);
    
    if (note.type === 'photo_scan') {
      // SQLite: PhotoScanç‰¹å®šå†™çœŸã®canvasDataæ›´æ–°
      await database.updatePhotoScanPage(noteId, pageId, canvasData);
    } else {
      // PostgreSQL: pages ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
      await pagesApi.updatePage(pageId, { canvas_data: canvasData });
    }
    
    console.log(`âœ… ãƒšãƒ¼ã‚¸ä¿å­˜å®Œäº†: ${pageId}`);
  }
  
  // ğŸ†• è‡ªå‹•ãƒšãƒ¼ã‚¸åˆ†å‰²
  static async splitPage(
    noteId: string,
    pageId: string,
    textContent: string,
    config: AutoSplitConfig
  ): Promise<{
    originalPage: UniversalNote['pages'][0];
    newPages: UniversalNote['pages'];
  }> {
    // ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ‡å®šå¢ƒç•Œã§åˆ†å‰²
    const splitTexts = this.splitTextByBoundary(textContent, config);
    
    const note = await this.getNote(noteId);
    const originalPageIndex = note.pages.findIndex(p => p.pageId === pageId);
    const originalPage = note.pages[originalPageIndex];
    
    // æ–°ã—ã„ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ
    const newPages = splitTexts.map((text, index) => ({
      pageId: `${pageId}_split_${index + 1}`,
      pageNumber: originalPage.pageNumber + index,
      canvasData: this.textToCanvasData(text),
      lastModified: new Date().toISOString(),
      pageMetadata: {
        ...originalPage.pageMetadata,
        isAutoSplit: true,
        originalPageId: pageId
      }
    }));
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°
    await this.replacePageWithMultiple(noteId, pageId, newPages);
    
    return { originalPage, newPages };
  }
  
  // ğŸ†• ãƒšãƒ¼ã‚¸è¿½åŠ 
  static async addPage(
    noteId: string, 
    pageData?: PageCreateData
  ): Promise<UniversalNote['pages'][0]> {
    const note = await this.getNote(noteId);
    
    const newPage: UniversalNote['pages'][0] = {
      pageId: generateUUID(),
      pageNumber: pageData?.pageNumber || note.pages.length + 1,
      canvasData: pageData?.canvasData || this.getEmptyCanvasData(),
      lastModified: new Date().toISOString(),
      pageMetadata: pageData?.pageMetadata
    };
    
    // ãƒšãƒ¼ã‚¸ç•ªå·èª¿æ•´ï¼ˆæ—¢å­˜ãƒšãƒ¼ã‚¸ã®ç•ªå·ã‚’ã‚·ãƒ•ãƒˆï¼‰
    if (pageData?.pageNumber && pageData.pageNumber <= note.pages.length) {
      await this.shiftPageNumbers(noteId, pageData.pageNumber, 1);
    }
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¿½åŠ 
    await this.insertPage(noteId, newPage);
    
    return newPage;
  }
  
  // ğŸ†• ãƒšãƒ¼ã‚¸ç•ªå·ã«ã‚ˆã‚‹ãƒšãƒ¼ã‚¸å–å¾—
  static async getPageByNumber(
    noteId: string, 
    pageNumber: number
  ): Promise<UniversalNote['pages'][0] | null> {
    const note = await this.getNote(noteId);
    return note.pages.find(p => p.pageNumber === pageNumber) || null;
  }
  
  // ğŸ†• å¤§å®¹é‡ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è‡ªå‹•åˆ†å‰²
  static async createNoteFromLargeContent(
    type: NoteType,
    title: string,
    content: string | Array<{ content: string; metadata?: any }>
  ): Promise<UniversalNote> {
    const noteId = generateUUID();
    
    let pages: UniversalNote['pages'];
    
    if (Array.isArray(content)) {
      // æ—¢ã«åˆ†å‰²æ¸ˆã¿ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆPDFå„ãƒšãƒ¼ã‚¸ã€å†™çœŸå„æšãªã©ï¼‰
      pages = content.map((item, index) => ({
        pageId: generateUUID(),
        pageNumber: index + 1,
        canvasData: this.textToCanvasData(item.content),
        lastModified: new Date().toISOString(),
        pageMetadata: item.metadata
      }));
    } else {
      // å˜ä¸€ã®å¤§å®¹é‡ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆ90åˆ†éŒ²éŸ³æ–‡å­—èµ·ã“ã—ãªã©ï¼‰
      const splitTexts = this.splitTextByBoundary(content, {
        enabled: true,
        maxCharactersPerPage: 2000,
        splitBoundary: 'paragraph',
        preserveStructure: true
      });
      
      pages = splitTexts.map((text, index) => ({
        pageId: generateUUID(),
        pageNumber: index + 1,
        canvasData: this.textToCanvasData(text),
        lastModified: new Date().toISOString(),
        pageMetadata: {
          isAutoGenerated: true,
          sourceType: type
        }
      }));
    }
    
    const note: UniversalNote = {
      id: noteId,
      type,
      title,
      pages,
      currentPage: {
        pageId: pages[0].pageId,
        pageNumber: 1
      },
      metadata: {
        totalPages: pages.length,
        autoSplitEnabled: true,
        maxCharactersPerPage: 2000,
        created_at: new Date().toISOString(),
        note_type: type
      },
      lastModified: new Date().toISOString()
    };
    
    await this.saveNote(note);
    return note;
  }
  
  // ğŸ†• ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ‡ãƒ¼ã‚¿å¤‰æ›ï¼ˆæ—¢å­˜ã®single-pageãƒãƒ¼ãƒˆ â†’ multi-pageãƒãƒ¼ãƒˆï¼‰
  static async convertLegacyNote(legacyNoteId: string): Promise<UniversalNote> {
    // æ—¢å­˜ã®CanvasEditorãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const legacyData = await database.getNote(legacyNoteId);
    
    // æ–°ã—ã„è¤‡æ•°ãƒšãƒ¼ã‚¸å½¢å¼ã«å¤‰æ›
    const convertedNote: UniversalNote = {
      id: legacyNoteId,
      type: legacyData.note_type,
      title: legacyData.title,
      pages: [{
        pageId: generateUUID(),
        pageNumber: 1,
        canvasData: legacyData.canvas_data,
        lastModified: legacyData.updated_at,
        pageMetadata: {
          isLegacyConversion: true
        }
      }],
      currentPage: {
        pageId: legacyData.pageId,
        pageNumber: 1
      },
      metadata: {
        totalPages: 1,
        autoSplitEnabled: false,
        created_at: legacyData.created_at,
        note_type: legacyData.note_type
      },
      lastModified: legacyData.updated_at
    };
    
    return convertedNote;
  }
}
```

### æ®µéšçš„ç§»è¡Œæˆ¦ç•¥

#### **âš ï¸ è¨­è¨ˆå¤‰æ›´: æœ€åˆã‹ã‚‰è¤‡æ•°ãƒšãƒ¼ã‚¸å¯¾å¿œ**

**ç†ç”±**: å…¨ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã§è¤‡æ•°ãƒšãƒ¼ã‚¸ãŒå¿…è¦
- **éŒ²éŸ³**: 90åˆ† â†’ 7ã€œ9ãƒšãƒ¼ã‚¸ã®æ–‡å­—èµ·ã“ã—
- **ã‚¤ãƒ³ãƒãƒ¼ãƒˆ**: PDF 20ãƒšãƒ¼ã‚¸ã€YouTube 1æ™‚é–“ â†’ è¤‡æ•°ãƒšãƒ¼ã‚¸
- **æ‰‹å‹•**: é•·æ™‚é–“ä½œæˆ â†’ è¤‡æ•°ãƒšãƒ¼ã‚¸
- **å†™çœŸã‚¹ã‚­ãƒ£ãƒ³**: è¤‡æ•°æš â†’ è¤‡æ•°ãƒšãƒ¼ã‚¸

#### **Phase 4.1-4.4: è¤‡æ•°ãƒšãƒ¼ã‚¸å¯¾å¿œçµ±ä¸€è‡ªå‹•ä¿å­˜**
- **æœ€åˆã‹ã‚‰è¤‡æ•°ãƒšãƒ¼ã‚¸å¯¾å¿œ**ã§å®Ÿè£…
- å˜ä¸€ãƒšãƒ¼ã‚¸ã¯ã€Œ1ãƒšãƒ¼ã‚¸ã®ã¿ã®è¤‡æ•°ãƒšãƒ¼ã‚¸ãƒãƒ¼ãƒˆã€ã¨ã—ã¦æ‰±ã†
- å…¨ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã§çµ±ä¸€ã•ã‚ŒãŸãƒšãƒ¼ã‚¸ç®¡ç†

#### **Phase 5: ãƒšãƒ¼ã‚¸ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½**
- CanvasEditorã«ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆUIè¿½åŠ 
- è‡ªå‹•ãƒšãƒ¼ã‚¸åˆ†å‰²ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
- ãƒšãƒ¼ã‚¸é–“ç§»å‹•ã¨ã‚­ãƒ£ãƒ³ãƒã‚¹åŒæœŸ

#### **Phase 6: ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ**
- SQLite PhotoScan â†’ PostgreSQL Pages è‡ªå‹•å¤‰æ›
- æ—¢å­˜è‡ªå‹•ä¿å­˜æ©Ÿèƒ½ã¯ç„¡åœæ­¢ã§ç¶™ç¶š

### å¾Œæ–¹äº’æ›æ€§ä¿è¨¼

âœ… **æ—¢å­˜ã®CanvasEditor**: å˜ä¸€ãƒšãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œç¶™ç¶š
âœ… **æ—¢å­˜ã®è‡ªå‹•ä¿å­˜**: å¤‰æ›´ãªã—ã§å‹•ä½œç¶™ç¶š
âœ… **æ—¢å­˜ã®PhotoScan**: è‡ªå‹•å¤‰æ›ã§æ–°å½¢å¼å¯¾å¿œ
âœ… **æ–°æ©Ÿèƒ½è¿½åŠ **: ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ‘ã‚¿ãƒ¼ãƒ³ã§è‡ªå‹•ç¶™æ‰¿

---

## ğŸ“Š **AIçµ±åˆå¾Œã®å®Œå…¨ä¿å­˜ã‚·ã‚¹ãƒ†ãƒ **

### ä¿å­˜å¯¾è±¡ã®å®Œå…¨ã‚«ãƒãƒ¬ãƒƒã‚¸

**100% ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½ + AIæ©Ÿèƒ½**:

#### **ãƒšãƒ³ãƒ„ãƒ¼ãƒ«ï¼ˆ7æ©Ÿèƒ½ï¼‰** â†’ å…¨ã¦`markAsChanged()`é€£æºæ¸ˆã¿
1. ãƒšãƒ³ã¨é‰›ç­†ã®åˆ‡ã‚Šæ›¿ãˆã¨æç”»
2. æ¶ˆã—ã‚´ãƒ 
3. ãƒãƒ¼ã‚«ãƒ¼
4. ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨æŒ¿å…¥ï¼‰
5. å®šè¦æ©Ÿèƒ½
6. ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ«ãƒ¼ãƒ©ãƒ¼æ©Ÿèƒ½
7. ãƒšãƒ³ã®å¤ªã•ã¨è‰²ã®å¤‰æ›´

#### **ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ„ãƒ¼ãƒ«ï¼ˆ7æ©Ÿèƒ½ï¼‰** â†’ å…¨ã¦`markAsChanged()`é€£æºæ¸ˆã¿
1. å…¥åŠ›
2. è¦‹å‡ºã—1ã€2ã€3ã€æœ¬æ–‡å¤‰æ›´
3. ãƒ•ã‚©ãƒ³ãƒˆå¤‰æ›´
4. ã‚µã‚¤ã‚ºå¤‰æ›´
5. å¤ªæ–‡å­—
6. è¡Œé–“å¤‰æ›´
7. æ–‡å­—é–“ã®é–“éš”å¤‰æ›´

#### **ãã®ä»–ãƒ„ãƒ¼ãƒ«ï¼ˆ4æ©Ÿèƒ½ï¼‰** â†’ å…¨ã¦`markAsChanged()`é€£æºæ¸ˆã¿
1. æ¤œç´¢æ©Ÿèƒ½
2. éŸ³å£°éŒ²éŸ³ã€å†ç”Ÿã€ä¸€æ™‚åœæ­¢ã€åœæ­¢
3. ã—ãŠã‚Šæ©Ÿèƒ½
4. è¨­å®šï¼ˆãƒšãƒ¼ã‚¸ã®è¨­å®šã‚„ç”¨ç´™ãƒ‡ã‚¶ã‚¤ãƒ³å¤‰æ›´ãªã©ï¼‰

#### **AIãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ï¼ˆ7æ©Ÿèƒ½ï¼‰** â†’ æ–°è¦çµ±åˆå®Œäº†
1. è¦ç´„
2. æ¼¢å­—ã€ã‚«ã‚¿ã‚«ãƒŠã€ã²ã‚‰ãŒãªã«å¤‰æ›æ©Ÿèƒ½
3. è¾æ›¸
4. æ ¡æ­£
5. ãµã‚ŠãŒãªã‚’æŒ¯ã‚‹æ©Ÿèƒ½
6. ãƒªã‚µãƒ¼ãƒæ©Ÿèƒ½
7. é€šå¸¸ãƒãƒ£ãƒƒãƒˆã¨éŸ³å£°å…¥åŠ›å¯¾å¿œ

**åˆè¨ˆ: 25æ©Ÿèƒ½ã™ã¹ã¦ã§ç¢ºå®Ÿãªè‡ªå‹•ä¿å­˜ä¿è¨¼**

**å…¨ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—å¯¾å¿œ**:
- âœ… recordingï¼ˆéŒ²éŸ³ãƒãƒ¼ãƒˆï¼‰ â†’ `Canvas data updated successfully (recording)`
- âœ… photo_scanï¼ˆå†™çœŸã‚¹ã‚­ãƒ£ãƒ³ï¼‰ â†’ `Canvas data updated successfully (photo scan)`  
- âœ… importï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼‰ â†’ `Canvas data updated successfully (import)`
- âœ… manualï¼ˆæ‰‹å‹•ä½œæˆï¼‰ â†’ `Canvas data updated successfully (manual)`

### çµ±åˆã‚·ã‚¹ãƒ†ãƒ ã®ä¿¡é ¼æ€§æŒ‡æ¨™

**ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**:
- ğŸ¯ ä¿å­˜ãƒ¬ã‚¹ãƒãƒ³ã‚¹: <100msï¼ˆAIå‡¦ç†å«ã‚€ï¼‰
- ğŸ¯ è‡ªå‹•ä¿å­˜é–“éš”: 5ç§’ï¼ˆè¨­å®šå¯èƒ½ï¼‰
- ğŸ¯ AIå‡¦ç†æ™‚é–“: <3ç§’ï¼ˆè¦ç´„ãƒ»æ ¡æ­£ï¼‰

**ä¿¡é ¼æ€§**:
- ğŸ¯ ä¿å­˜æˆåŠŸç‡: 99.9%ï¼ˆ3æ®µéšãƒªãƒˆãƒ©ã‚¤ï¼‰
- ğŸ¯ ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§: 100%ï¼ˆUndo/Redoå®Œå…¨å¯¾å¿œï¼‰
- ğŸ¯ ç«¶åˆé˜²æ­¢: 100%ï¼ˆisSaving + isAIProcessing ãƒ•ãƒ©ã‚°ï¼‰

---

## ğŸ¯ **Phase 4å®Ÿè£…å®Œäº†æ™‚ã®é”æˆçŠ¶æ…‹**

**âœ… å•é¡Œè§£æ±ºå®Œäº†**:
1. **éŒ²éŸ³ãƒãƒ¼ãƒˆ**: ãƒšãƒ³ãƒ„ãƒ¼ãƒ«ãƒ»ãƒ†ã‚­ã‚¹ãƒˆä»¥å¤–ã®æ©Ÿèƒ½ã§ã‚‚100%è‡ªå‹•ä¿å­˜
2. **å†™çœŸã‚¹ã‚­ãƒ£ãƒ³ãƒãƒ¼ãƒˆ**: å…¨ã¦ã®ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½ã§100%è‡ªå‹•ä¿å­˜  
3. **AIæ©Ÿèƒ½**: è¦ç´„ãƒ»æ ¡æ­£ãƒ»å¤‰æ›ç­‰ã®çµæœã‚‚ç¢ºå®Ÿã«è‡ªå‹•ä¿å­˜
4. **æ–°æ©Ÿèƒ½å¯¾å¿œ**: TTSãƒ»ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»å®šè¦æ©Ÿèƒ½ã‚‚è‡ªå‹•ç¶™æ‰¿

**âœ… é–‹ç™ºåŠ¹ç‡å‘ä¸Š**:
- æ–°æ©Ÿèƒ½è¿½åŠ æ™‚ã®è‡ªå‹•ä¿å­˜ã‚³ãƒ¼ãƒ‰ãŒä¸è¦ï¼ˆãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã§è‡ªå‹•é©ç”¨ï¼‰
- ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®è‡ªå‹•ç”Ÿæˆï¼ˆ104é …ç›® â†’ 1æ™‚é–“ã§å®Œäº†ï¼‰
- ãƒã‚°ç™ºç”Ÿç‡ã®å¤§å¹…å‰Šæ¸›ï¼ˆæ‰‹å‹•ä¿å­˜ã‚³ãƒ¼ãƒ‰ã®æ’é™¤ï¼‰

**âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Š**:
- ãƒ‡ãƒ¼ã‚¿æå¤±ãƒªã‚¹ã‚¯: 0%ï¼ˆ100%è‡ªå‹•ä¿å­˜ä¿è¨¼ï¼‰
- æ“ä½œé…å»¶: 0msï¼ˆéåŒæœŸä¿å­˜ï¼‰
- å­¦ç¿’éšœå®³å…å¯¾å¿œ: å®Œç’§ï¼ˆä¸­æ–­ãªã—å­¦ç¿’ç’°å¢ƒï¼‰
