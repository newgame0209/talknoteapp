## 📋 リアルタイム文字起こし機能 – **修正版実装計画**

### 1. 目的（仕様再確認）
録音アイコン → 最大 60 秒まで録音しながら **250 ms ごとに音声チャンクを WebSocket `/api/v1/stt/stream` に送信**。サーバーからの部分認識テキストを即時表示し、停止時に確定テキストをキャンバスへ挿入する。

> 仕様要件
> 1. 60 秒上限（60 000 ms）
> 2. クラウド保存なし（ローカル DB にのみ flushSave）
> 3. UI は既存マイク / ⏸ / ⏹ ボタン + 残り時間表示を流用
> 4. ⏸ で録音・送信停止、▶️ で再開
> 5. 停止または 60 秒到達で録音終了 & テキスト確定挿入
> 6. 挿入位置は既存テキスト末尾。2 000 字超過時は自動ページ分割後 flushSave()

### 2. 現状課題
| # | 問題 | 影響 |
|---|------|------|
|①|`sendAudioChunk()` が録音 URI だけ送信し PCM データを送っていない| サーバーが音声を取得できず文字起こしレスポンスが返らない|
|②|expo-av の `Recording` では録音途中のバイト列を直接取得できない| 本来のリアルタイム送信が不完全 |
|③|型エラー (RouteProp 未使用 etc.) が多く CI が赤 | デプロイに支障 |

### 3. 解決方針
「**差分バイトを base64 で送信**」方式に変更し、expo-av でもリアルタイム化を実現。
1. 録音ファイル全体のサイズを `FileSystem.getInfoAsync()` で取得。  
2. 前回送信以降の **追記分だけ** `FileSystem.readAsStringAsync(uri,{encoding:'base64',length,new position})` で読み出し。  
3. WebSocket へ `{ type:'audio_chunk', audio_data:'<base64>' }` を送信。
   * サーバー実装は既に `audio_data` を受け付ける。
4. 差分追跡用に `lastSentBytes` をクライアント側で管理。

### 4. タスク一覧（新規）
- [ ] **B-1. RealtimeSttClient 差分送信対応**  
  └ `lastSentBytes` 管理・`sendAudioChunk()` 全書き換え。
- [ ] **B-2. 初期ハンドシェイク調整**  
  └ 設定送信→`{"event":"start"}` を追加（必要時）。
- [ ] **B-3. 再接続ロジック**  
  └ `ws.onclose` で録音中は最大 3 回自動リトライ。
- [ ] **B-4. CanvasEditor UI 微修正**  
  └ 残り時間 = `60-elapsed` 秒表示 / ボタン連打防止。
- [ ] **B-5. TypeScript 型エラー整理**  
  └ 未使用 import 削除・`tsc --noEmit` パス。

### 5. 変更対象ファイル
| ファイル | 作業内容 |
|---|---|
| `app/services/RealtimeSttClient.ts` | B-1, B-2, B-3 |
| `app/screens/CanvasEditor.tsx` | B-4 |
| その他（型調整） | B-5 |

### 6. スケジュール
| 日時 | 作業 |
|-----|-----|
| 今日 13:00-15:30 | B-1, B-2 実装 + 単体テスト |
| ‑ 16:30 | B-3, B-4 実装 |
| ‑ 17:30 | B-5, 動作テスト（58 s 録音 / ⏸▶️ / 2 000 字分割） |
| ‑ 18:00 | PR → EAS Update dev ブランチ |

### 7. テスト項目
1. 58 秒連続録音 → 自動停止・全文挿入
2. 30 秒録音 → ⏸ 5 秒 → ▶️ 再開 → 55 秒で手動⏹ → 全文挿入
3. ネット切断→再接続 (機内モード 3 秒) → 自動再接続し文字起こし継続
4. 2 000 字超過で `performPageSplit()` が呼ばれる
5. `tsc --noEmit` が通る

### 8. リスク / Mitigation
* iOS sandbox で 250 ms 以内にファイル I/O が遅延する可能性  
  → チャンク 500 ms へ動的伸縮ロジックを用意（失敗 3 回で 500 ms）。
* WebSocket 切断後のリトライ上限超え  
  → 録音を自動停止し UI に Toast。

---
この計画で **仕様 1-6** を完全順守しつつ、不足していた音声データ送信を実装します。